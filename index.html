<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Skywars Ultimate</title>
<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&amp;family=Orbitron:wght@500;700;900&amp;family=Share+Tech+Mono&amp;display=swap" rel="stylesheet">
<style>
:root {
  --cyan:#00e8ff; --pink:#ff2d78; --gold:#ffd530; --green:#28ffb2;
  --red:#ff3050; --purple:#b040ff; --orange:#ff8830;
  --bg-deep:#030811; --bg-mid:#0a1628; --bg-light:#122040;
  --ui-bg:rgba(6,14,30,0.88); --ui-border:rgba(0,232,255,0.2);
  --glass:rgba(255,255,255,0.04);
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg-deep);font-family:'Chakra Petch',sans-serif;color:#fff;user-select:none;-webkit-user-select:none}
canvas#game{display:block;width:100%;height:100%;position:fixed;top:0;left:0}

/* ---- HUD ---- */
#hud{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:flex-start;padding:10px 12px;pointer-events:none;z-index:100;opacity:0;transition:opacity .4s}
#hud.active{opacity:1}
.hp{display:flex;flex-direction:column;gap:3px}
.bar-wrap{height:14px;border-radius:7px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,0.08)}
.bar-hp-wrap{width:180px;background:rgba(255,48,80,0.12)}
.bar-shield-wrap{width:180px;height:10px;border-radius:5px;background:rgba(0,200,255,0.08)}
.bar-xp-wrap{width:180px;height:8px;border-radius:4px;background:rgba(255,213,48,0.08)}
.bar-xp{background:linear-gradient(90deg,#44ffcc,#ffd530);box-shadow:0 0 8px rgba(255,213,48,.35)}
.bar-fill{height:100%;border-radius:inherit;transition:width .25s ease}
.bar-hp{background:linear-gradient(90deg,#ff2040,#ff6060);box-shadow:0 0 10px rgba(255,48,80,0.4)}
.bar-shield{background:linear-gradient(90deg,#2080ff,#00e8ff);box-shadow:0 0 8px rgba(0,200,255,0.3)}
.bar-label{position:absolute;right:6px;top:50%;transform:translateY(-50%);font:600 10px 'Share Tech Mono',monospace;color:rgba(255,255,255,0.8);text-shadow:0 0 4px rgba(0,0,0,0.8);letter-spacing:.5px}
.hud-mid{text-align:center}
.hud-right{text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:2px}
.lbl{font:700 11px 'Orbitron',sans-serif;letter-spacing:1.5px}
.lbl-cy{color:var(--cyan);text-shadow:0 0 8px rgba(0,232,255,0.4)}
.lbl-gd{color:var(--gold);text-shadow:0 0 8px rgba(255,213,48,0.4)}
.lbl-gn{color:var(--green);text-shadow:0 0 8px rgba(40,255,178,0.4)}
.lbl-pk{color:var(--pink);text-shadow:0 0 8px rgba(255,45,120,0.4)}
.lbl-rd{color:var(--red);text-shadow:0 0 8px rgba(255,48,80,0.4)}
.wave-lbl{font:900 18px 'Orbitron',sans-serif;color:var(--gold);text-shadow:0 0 12px rgba(255,213,48,0.5)}

/* Killfeed */
#killfeed{position:fixed;top:55px;right:12px;display:flex;flex-direction:column;gap:3px;pointer-events:none;z-index:100}
.kf{background:rgba(6,14,30,0.82);border:1px solid rgba(255,45,120,0.25);border-radius:5px;padding:3px 10px;font:600 11px 'Chakra Petch',sans-serif;color:#ff88bb;animation:kfIn .25s ease-out;white-space:nowrap}
@keyframes kfIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}

/* Minimap */
#minimap-c{position:fixed;bottom:12px;right:12px;width:120px;height:120px;border-radius:10px;overflow:hidden;border:1px solid var(--ui-border);background:var(--ui-bg);box-shadow:0 0 15px rgba(0,232,255,0.1);z-index:100;pointer-events:none;opacity:0;transition:opacity .4s}
#minimap-c.active{opacity:1}
#minimap{width:100%;height:100%}

/* Weapon bar */
#wbar{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:4px;z-index:100;pointer-events:auto;opacity:0;transition:opacity .4s}
#wbar.active{opacity:1}
.ws{width:52px;height:52px;background:var(--ui-bg);border:2px solid rgba(255,255,255,0.08);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;position:relative}
.ws.on{border-color:var(--cyan);box-shadow:0 0 14px rgba(0,232,255,0.35),inset 0 0 10px rgba(0,232,255,0.08)}
.ws .wi{font-size:20px}.ws .wk{position:absolute;top:2px;left:5px;font:700 8px 'Orbitron',sans-serif;color:rgba(255,255,255,0.35)}
.ws .wa{position:absolute;bottom:2px;right:5px;font:700 9px 'Share Tech Mono',monospace;color:var(--gold)}
.ws .reload-bar{position:absolute;bottom:0;left:0;height:3px;background:var(--cyan);border-radius:0 0 6px 6px;transition:width 50ms linear}

/* Ability */
#abil{position:fixed;bottom:72px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:100;pointer-events:none;opacity:0;transition:opacity .4s}
#abil.active{opacity:1}
.ab{width:42px;height:42px;background:var(--ui-bg);border:2px solid var(--purple);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;position:relative}
.ab .cd{position:absolute;inset:0;background:rgba(0,0,0,0.7);border-radius:6px;display:flex;align-items:center;justify-content:center;font:700 12px 'Orbitron',sans-serif;color:#fff}
.ab .ak{position:absolute;bottom:-14px;font:700 8px 'Orbitron',sans-serif;color:rgba(255,255,255,0.35)}

/* Crosshair */
#cross{position:fixed;top:50%;left:50%;width:28px;height:28px;transform:translate(-50%,-50%);pointer-events:none;z-index:200;opacity:0;transition:opacity .3s}
#cross.active{opacity:1}
#cross::before,#cross::after{content:'';position:absolute;background:rgba(255,255,255,0.75)}
#cross::before{width:1.5px;height:100%;left:50%;transform:translateX(-50%)}
#cross::after{height:1.5px;width:100%;top:50%;transform:translateY(-50%)}
.cdot{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:4px;height:4px;border-radius:50%;background:var(--cyan);box-shadow:0 0 6px var(--cyan)}

/* Boss bar */
#bossbar{position:fixed;top:48px;left:50%;transform:translateX(-50%);width:min(320px,75vw);z-index:100;pointer-events:none;display:none}
.bn{font:700 11px 'Orbitron',sans-serif;color:var(--red);text-align:center;margin-bottom:2px;text-shadow:0 0 8px rgba(255,48,80,0.5);letter-spacing:2px}
.bbw{width:100%;height:8px;background:rgba(255,0,0,0.08);border-radius:4px;overflow:hidden;border:1px solid rgba(255,48,80,0.25)}
.bbf{height:100%;background:linear-gradient(90deg,#ff2244,#ff6644,#ff2244);background-size:200% 100%;animation:bpulse 1.5s linear infinite;border-radius:4px;transition:width .3s}
@keyframes bpulse{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}

/* Wave announce */
#wannounce{position:fixed;top:25%;left:50%;transform:translate(-50%,-50%);font:900 clamp(24px,7vw,52px) 'Orbitron',sans-serif;color:var(--gold);text-shadow:0 0 20px rgba(255,213,48,0.5),0 0 40px rgba(255,213,48,0.2);pointer-events:none;z-index:150;opacity:0;transition:opacity .5s;text-align:center;white-space:nowrap}
#wannounce.on{opacity:1}

/* Super powers HUD */
#superbar{position:fixed;left:12px;bottom:12px;z-index:130;opacity:0;transition:opacity .35s;pointer-events:none}
#superbar.active{opacity:1}
#superEWrap{width:210px;height:10px;border-radius:6px;overflow:hidden;background:rgba(0,0,0,.35);border:1px solid rgba(0,232,255,.35);margin-bottom:7px}
#superEFill{height:100%;width:0;background:linear-gradient(90deg,#00e8ff,#b040ff,#ffd530);box-shadow:0 0 10px rgba(0,232,255,.45);transition:width .2s}
#superSlots{display:flex;gap:6px}
.sp-slot{min-width:64px;padding:4px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.14);background:rgba(6,14,30,.78);text-align:center;font:700 9px 'Orbitron',sans-serif;letter-spacing:1px;color:rgba(255,255,255,.65)}
.sp-slot.ready{border-color:#28ffb2;color:#28ffb2;box-shadow:0 0 10px rgba(40,255,178,.25)}
.sp-slot .k{display:block;color:rgba(255,255,255,.35);font-size:8px;margin-top:2px}

/* Screens */
.scr{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;background:rgba(3,8,17,0.96);backdrop-filter:blur(16px);transition:opacity .4s}
#scrTitle{justify-content:flex-start;overflow-y:auto;padding:24px 14px 32px}
#scrTitle .ttl{margin-top:4px}
.title-tools{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:8px 0}
.ctrl-box{max-height:0;overflow:hidden;transition:max-height .25s ease,opacity .2s ease;opacity:.1}
.ctrl-box.on{max-height:160px;opacity:1}
.scr.off{opacity:0;pointer-events:none}
.ttl{font:900 clamp(30px,9vw,68px) 'Orbitron',sans-serif;letter-spacing:4px;background:linear-gradient(135deg,var(--cyan),var(--pink),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 20px rgba(0,232,255,0.3))}
.sub{font:500 clamp(12px,2.5vw,18px) 'Chakra Petch',sans-serif;color:rgba(255,255,255,0.35);letter-spacing:8px;text-transform:uppercase;margin:4px 0 24px}

.btn-go{font:700 16px 'Orbitron',sans-serif;padding:12px 44px;border:2px solid var(--cyan);background:rgba(0,232,255,0.06);color:var(--cyan);border-radius:6px;cursor:pointer;letter-spacing:3px;text-transform:uppercase;transition:all .25s;box-shadow:0 0 15px rgba(0,232,255,0.1)}
.btn-go:hover{background:rgba(0,232,255,0.15);box-shadow:0 0 25px rgba(0,232,255,0.3);transform:scale(1.04)}

.cls-grid{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;justify-content:center}
.cls{width:110px;padding:12px 8px;background:var(--glass);border:1px solid rgba(255,255,255,0.08);border-radius:10px;text-align:center;cursor:pointer;transition:all .2s}
.cls:hover,.cls.sel{border-color:var(--cyan);box-shadow:0 0 12px rgba(0,232,255,0.2);background:rgba(0,232,255,0.06)}
.cls-i{font-size:28px;margin-bottom:4px}
.cls-n{font:700 10px 'Orbitron',sans-serif;color:var(--cyan);letter-spacing:1px}
.cls-d{font-size:10px;color:rgba(255,255,255,0.35);margin-top:3px;line-height:1.3}

/* Game Over */
.go-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin:16px 0;max-width:280px}
.go-s{background:var(--glass);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:10px;text-align:center}
.go-v{font:900 20px 'Orbitron',sans-serif;color:var(--gold)}
.go-l{font:500 10px 'Chakra Petch',sans-serif;color:rgba(255,255,255,0.35);letter-spacing:1px;text-transform:uppercase;margin-top:2px}

/* Meta stats / pause */
.meta{margin:12px 0 18px;padding:10px 16px;border:1px solid var(--ui-border);border-radius:8px;background:rgba(0,232,255,0.04);font:600 12px 'Share Tech Mono',monospace;color:rgba(255,255,255,0.72);letter-spacing:1px;text-align:center}
.meta b{color:var(--gold)}
#pause{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:450;background:rgba(3,8,17,.7);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .25s}
#pause.on{opacity:1;pointer-events:auto}
#pause .ttl{font-size:clamp(26px,8vw,58px)}
#pause .sub{margin:8px 0 0;color:rgba(255,255,255,0.55);letter-spacing:3px}

/* Mobile */
#mob{display:none;position:fixed;inset:0;pointer-events:none;z-index:400}
.joy{position:fixed;bottom:28px;left:28px;width:110px;height:110px;pointer-events:auto;touch-action:none}
.joy-base{width:100%;height:100%;border-radius:50%;background:rgba(255,255,255,0.06);border:2px solid rgba(255,255,255,0.12)}
.joy-thumb{width:40px;height:40px;border-radius:50%;background:rgba(0,232,255,0.25);border:2px solid var(--cyan);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);box-shadow:0 0 8px rgba(0,232,255,0.2)}
.mbtn{pointer-events:auto;border-radius:50%;border:2px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.6);-webkit-tap-highlight-color:transparent;touch-action:none}
.mbtn:active{background:rgba(0,232,255,0.15);border-color:var(--cyan)}
#m-fire{position:fixed;bottom:35px;right:28px;width:66px;height:66px;font-size:26px}
#m-jump{position:fixed;bottom:110px;right:32px;width:52px;height:52px;font-size:20px}
#m-abil{position:fixed;bottom:35px;right:104px;width:52px;height:52px;font-size:18px}
#m-rl{position:fixed;bottom:110px;right:104px;width:48px;height:48px;font:700 12px 'Orbitron',sans-serif}
#m-sw{position:fixed;bottom:185px;right:32px;width:48px;height:48px;font:700 12px 'Chakra Petch',sans-serif}

/* Floating text overlay */
.ft{position:fixed;pointer-events:none;z-index:250;font:700 14px 'Orbitron',sans-serif;animation:ftUp 1.2s ease-out forwards}
@keyframes ftUp{0%{opacity:1;transform:translate(-50%,0) scale(1.1)}100%{opacity:0;transform:translate(-50%,-45px) scale(.75)}}
.dmg{position:fixed;pointer-events:none;z-index:300;font-weight:700;font-family:'Orbitron',sans-serif;animation:dmgUp .8s ease-out forwards}
@keyframes dmgUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-35px) scale(.6)}}

/* Responsive */
@media(max-width:600px){
  #hud{padding:6px 8px}
  .bar-hp-wrap,.bar-shield-wrap{width:120px}
  .bar-hp-wrap{height:11px}
  .bar-shield-wrap{height:8px}
  .lbl{font-size:9px}
  .wave-lbl{font-size:13px}
  .ws{width:40px;height:40px}.ws .wi{font-size:16px}
  #minimap-c{width:85px;height:85px}
  .cls{width:85px;padding:8px 5px}
  .cls-i{font-size:22px}
  #mob{display:block}
}
@media(hover:none)and(pointer:coarse){#mob{display:block}}

/* Tooltip */
.tip{position:fixed;pointer-events:none;z-index:200;background:var(--ui-bg);border:1px solid var(--ui-border);border-radius:5px;padding:3px 9px;font:600 11px 'Chakra Petch',sans-serif;color:var(--cyan);white-space:nowrap;opacity:0;transition:opacity .15s}
.tip.on{opacity:1}

.controls-hint{color:rgba(255,255,255,0.22);font:400 11px 'Share Tech Mono',monospace;letter-spacing:1.5px;margin-top:14px;text-align:center;line-height:1.6}
.diff-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:6px 0 6px}
.diff-btn{padding:7px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.04);color:rgba(255,255,255,.6);font:700 10px 'Orbitron',sans-serif;letter-spacing:1.2px;cursor:pointer;transition:all .2s}
.diff-btn.on{border-color:var(--cyan);color:var(--cyan);box-shadow:0 0 12px rgba(0,232,255,.25)}
.diff-desc{font:500 10px 'Chakra Petch',sans-serif;color:rgba(255,255,255,.4);margin-bottom:10px;text-align:center}
.mode-row{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:4px 0 8px}
.mode-btn{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.03);color:rgba(255,255,255,.6);font:700 9px 'Orbitron',sans-serif;letter-spacing:1px;cursor:pointer}
.mode-btn.on{border-color:var(--gold);color:var(--gold);box-shadow:0 0 10px rgba(255,213,48,.25)}
.profile-meta{margin:8px 0 10px;padding:8px 12px;border:1px solid rgba(40,255,178,.25);border-radius:8px;background:rgba(40,255,178,.05);font:600 11px 'Share Tech Mono',monospace;color:rgba(255,255,255,.72)}
#shop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:460;background:rgba(2,10,20,.82);backdrop-filter:blur(10px);opacity:0;pointer-events:none;transition:opacity .25s}
#shop.on{opacity:1;pointer-events:auto}
#shopCard{width:min(560px,92vw);border:1px solid var(--ui-border);background:rgba(8,18,35,.92);border-radius:12px;padding:14px}
#shopGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin:10px 0}
.shop-it{border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:10px;background:rgba(255,255,255,.03);cursor:pointer;font:600 11px 'Chakra Petch',sans-serif;color:rgba(255,255,255,.8)}
.shop-it small{display:block;color:rgba(255,255,255,.4)}
.sfx-btn{pointer-events:auto;margin-top:6px;padding:5px 10px;border:1px solid rgba(0,232,255,.35);border-radius:999px;background:rgba(0,232,255,.08);color:var(--cyan);font:700 10px 'Orbitron',sans-serif;letter-spacing:1px;cursor:pointer;transition:all .2s}
.sfx-btn.off{opacity:.45;filter:saturate(.3)}
#vfx{position:fixed;inset:0;pointer-events:none;z-index:90;background:radial-gradient(circle at center,transparent 30%,rgba(0,0,0,.4) 100%);mix-blend-mode:screen;opacity:.2}
.tiny-meta{font:600 10px 'Share Tech Mono',monospace;color:rgba(255,255,255,.5);margin-top:6px;text-align:center}
#contracts{position:fixed;left:12px;top:84px;z-index:120;background:rgba(6,14,30,.68);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:6px 8px;font:600 10px 'Share Tech Mono',monospace;color:rgba(255,255,255,.75);max-width:280px;opacity:.9}
.skill-row{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;margin:4px 0 6px}
.skill-btn{padding:5px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.03);font:700 9px 'Orbitron',sans-serif;color:rgba(255,255,255,.7);cursor:pointer}
.skill-btn.on{border-color:#28ffb2;color:#28ffb2}
.badges{font:600 10px 'Share Tech Mono',monospace;color:rgba(255,255,255,.6);margin-top:4px;text-align:center}
.online-panel{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:6px 0 2px}
.online-in{width:120px;max-width:38vw;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);color:rgba(255,255,255,.85);font:600 10px 'Share Tech Mono',monospace}
.online-in::placeholder{color:rgba(255,255,255,.45)}
#connectBtn{padding:6px 10px;border-radius:999px;border:1px solid rgba(0,232,255,.35);background:rgba(0,232,255,.1);color:var(--cyan);font:700 9px 'Orbitron',sans-serif;cursor:pointer}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="cross"><div class="cdot"></div></div>

<div id="hud">
  <div class="hp">
    <div class="bar-wrap bar-hp-wrap"><div class="bar-fill bar-hp" id="hpBar"></div><div class="bar-label" id="hpLbl">100</div></div>
    <div class="bar-wrap bar-shield-wrap"><div class="bar-fill bar-shield" id="shBar"></div></div>
    <div class="bar-wrap bar-xp-wrap"><div class="bar-fill bar-xp" id="xpBar"></div></div>
  </div>
  <div class="hud-mid">
    <div class="wave-lbl" id="waveLbl">WAVE 1</div>
    <div class="lbl lbl-pk" id="eLbl">12 HOSTILES</div>
  </div>
  <div class="hud-right">
    <span class="lbl lbl-gd" id="scoreLbl">0</span>
    <span class="lbl lbl-gn" id="killLbl">KILLS 0</span>
    <span class="lbl lbl-pk" id="comboLbl"></span>
  </div>
</div>

<button class="sfx-btn" id="sfxBtn" style="position:fixed;top:12px;right:12px;z-index:130">SFX ON</button>
<div id="vfx"></div>
<div id="superbar">
  <div id="superEWrap"><div id="superEFill"></div></div>
  <div id="superSlots"></div>
</div>

<div id="contracts">Contracts: waiting... Â· Inv: empty</div>
<div id="killfeed"></div>
<div id="minimap-c"><canvas id="minimap"></canvas></div>
<div id="wbar"></div>
<div id="abil"></div>
<div id="bossbar"><div class="bn" id="bossN">BOSS</div><div class="bbw"><div class="bbf" id="bossF"></div></div></div>
<div id="wannounce"></div>
<div class="tip" id="tip"></div>

<!-- Title -->
<div class="scr" id="scrTitle">
  <div class="ttl">SKYWARS</div>
  <div class="sub">Ultimate</div>
  <div class="cls-grid" id="clsGrid"></div>
  <div class="diff-row" id="diffRow"></div>
  <div class="diff-desc" id="diffDesc"></div>
  <div class="mode-row" id="modeRow"></div>
  <div class="mode-row" id="talentRow"></div>
  <div class="skill-row" id="skillRow"></div>
  <div class="mode-row" id="coopRow"></div>
  <div class="mode-row" id="skinRow"></div>
  <div class="mode-row" id="avatarRow"></div>
  <div class="tiny-meta" id="onlineMeta">Online PvP: offline</div>
  <div class="online-panel" id="onlinePanel">
    <input id="nickInput" class="online-in" maxlength="14" placeholder="Usuario" value="Player">
    <input id="roomInput" class="online-in" maxlength="20" placeholder="CÃ³digo sala" value="room1">
    <button id="connectBtn">Conectar</button>
  </div>
  <div class="tiny-meta" id="dailyMeta">Daily: -</div>
  <div class="profile-meta" id="profileMeta">LV 1 Â· XP 0/100 Â· Tokens 0</div>
  <div class="badges" id="badgeMeta">Badges: none</div>
  <div class="meta" id="titleMeta">Best Score <b>0</b> Â· Best Wave <b>0</b> Â· Mode Best <b>0</b></div>
  <div class="title-tools">
    <button class="mode-btn" id="toggleControls">Ver controles</button>
    <button class="mode-btn" id="perfBtn">Modo rendimiento: AUTO</button>
  </div>
  <button class="btn-go" id="btnPlay">DEPLOY</button>
  <div class="ctrl-box" id="controlsBox"><div class="controls-hint">WASD move Â· Mouse aim Â· Click fire Â· R reload<br>Space jump Â· Q ability Â· E interact Â· Z/X/C supers Â· V/B/N/M powers Â· 1-5 weapons Â· ESC pause Â· decision cada 3 waves</div></div>
</div>

<!-- Game Over -->
<div class="scr off" id="scrGO">
  <div class="ttl" id="goTitle" style="font-size:clamp(22px,6vw,40px)">MISSION FAILED</div>
  <div class="go-grid" id="goGrid"></div>
  <div class="meta" id="goMeta">Session Best <b>0</b></div>
  <button class="btn-go" id="btnRetry">REDEPLOY</button>
</div>

<div id="pause">
  <div class="ttl">PAUSED</div>
  <div class="sub">Press ESC to continue</div>
</div>

<div id="shop">
  <div id="shopCard">
    <div class="ttl" style="font-size:clamp(18px,5vw,34px)">ARMORY SHOP</div>
    <div class="sub" id="shopInfo" style="margin:2px 0 8px;letter-spacing:2px">Choose one upgrade</div>
    <div id="shopGrid"></div>
    <button class="btn-go" id="shopContinue" style="width:100%;margin-top:6px">CONTINUE</button>
  </div>
</div>

<!-- Mobile -->
<div id="mob">
  <div class="joy" id="joyArea"><div class="joy-base"><div class="joy-thumb" id="joyThumb"></div></div></div>
  <div class="mbtn" id="m-fire">ğŸ”«</div>
  <div class="mbtn" id="m-jump">â¬†</div>
  <div class="mbtn" id="m-abil">âš¡</div>
  <div class="mbtn" id="m-rl">R</div>
  <div class="mbtn" id="m-sw">â‡„</div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKYWARS ULTIMATE â€” Professional Rewrite v2
   Proper physics, solid collision, polished everything
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const C = document.getElementById('game');
const X = C.getContext('2d');
let W, H;
function onResize(){ W = C.width = innerWidth; H = C.height = innerHeight; }
onResize(); addEventListener('resize', onResize);

/* ---- Math helpers ---- */
const PI = Math.PI, TAU = PI*2;
const sin = Math.sin, cos = Math.cos, abs = Math.abs, hypot = Math.hypot,
      floor = Math.floor, ceil = Math.ceil, min = Math.min, max = Math.max, round = Math.round;
function lerp(a,b,t){return a+(b-a)*t;}
function clamp(v,lo,hi){return v<lo?lo:v>hi?hi:v;}
function rnd(a,b){return Math.random()*(b-a)+a;}
function rndI(a,b){return floor(rnd(a,b+1));}
function dst(x1,y1,x2,y2){return hypot(x2-x1,y2-y1);}
function ang(x1,y1,x2,y2){return Math.atan2(y2-y1,x2-x1);}
function pct(v){return Math.random()<v;}
function pick(a){return a[floor(Math.random()*a.length)];}

/* ---- CONSTANTS ---- */
const GRAV = 0.45;
const VOID_DEPTH = 500;
const MAX_ENEMIES = 26;
const STAR_N = 90;

/* ---- Global state ---- */
var state = 'title';
var score=0, kills=0, wave=0, combo=0, comboT=0, maxCombo=0, dmgDealt=0;
var shake=0, slowT=0, slowF=1;
var enThisWave=0, enKilled=0;
var bossOn=false, bossRef=null;
var frameN=0;
var bestScore=0, bestWave=0;
var overdriveT=0;
var superE=0, chronoT=0, stormT=0, stormTick=0;
var superCD={nova:0,chrono:0,storm:0};

var SUPERS={
  nova:{name:'NOVA',key:'Z',cost:34,cd:9,col:'#ff8830'},
  chrono:{name:'CHRONO',key:'X',cost:38,cd:14,col:'#00e8ff'},
  storm:{name:'STORM',key:'C',cost:42,cd:16,col:'#b040ff'}
};

var DIFFS={
  casual:{name:'CASUAL',desc:'MÃ¡s perdÃ³n, menos daÃ±o enemigo',spawnMul:1.2,hpMul:.85,dmgMul:.78,scoreMul:.9,eliteBonus:-.05,col:'#28ffb2'},
  normal:{name:'NORMAL',desc:'Experiencia equilibrada',spawnMul:1,hpMul:1,dmgMul:1,scoreMul:1,eliteBonus:0,col:'#00e8ff'},
  nightmare:{name:'NIGHTMARE',desc:'Enemigos mÃ¡s agresivos, mejor score',spawnMul:.82,hpMul:1.28,dmgMul:1.35,scoreMul:1.45,eliteBonus:.08,col:'#ff2d78'}
};
var selDiff='normal';
var MODES={
  classic:{name:'CLASSIC',desc:'Modo estÃ¡ndar'},
  hardcore:{name:'ENDLESS HC',desc:'Sin tienda entre oleadas'},
  onelife:{name:'1 LIFE',desc:'Solo 1 vida'},
  sniper:{name:'ONLY SNIPER',desc:'Solo rifle de francotirador'},
  timeattack:{name:'TIME ATTACK',desc:'Sobrevive 5 minutos'},
  speed:{name:'SPEED x2',desc:'Enemigos ultra rÃ¡pidos'},
  chaos:{name:'CHAOS',desc:'Todo activo, dificultad absurda'},
  pvp:{name:'PVP LOCAL',desc:'Duelo local 1v1'},
  pvp_online:{name:'PVP ONLINE',desc:'Duelo online (beta por sala)'}
};
var selMode='classic';
var modeTimeLeft=300;
var shopPending=false;
var eventState={name:'',t:0,meteor:0,storm:0,toxic:0,exploders:0};
var runBuffs={dmg:1,spd:1,combo:1,shield:0};
var shopWaveLock=0;
var modeBest={classic:0,hardcore:0,onelife:0,sniper:0,timeattack:0,speed:0,chaos:0,pvp:0,pvp_online:0};
var runStart=0, runXP=0;
var talents={glass:0,adrenaline:0,guardian:0};
var selTalent='glass';
var deckCards=[];
var curse={name:'',active:false,mult:1};
var pet={lvl:1,x:0,y:0,cd:0,upgrade:0};
var contracts={kill:0,target:25,boss:0,targetBoss:1,done:false};
var achieves={};
var daily={day:'',challenge:'',goal:0,progress:0,streak:0};
var biome='Sky';
var portals=[];
var traps=[];
var globalRank=[];
var uiTick=0;
var mapSet='Ciudad destruida';
var mapFx={meteor:1,toxic:0,lowG:0,turret:0};
var perf={low:false,avg:16,force:false};

var prog={xp:0,lvl:1,tokens:0,coins:0,title:'Rookie',badges:[],skillPts:0,skills:{dmg:0,spd:0,crit:0,def:0},permDmg:1,permSpd:1,crit:0,defMul:1,unlocks:{laser:false,launcher:false,sniper:false,skinRare:false,skinEpic:false,skinLegend:false}};
var cosmetics={skin:'base',bulletFx:'base',trail:'base',avatar:'zr7'};
var inventory={relic:null,artifact:null,items:[]};
var coop={on:false,ally:{x:0,y:0,vx:0,vy:0,hp:120,mhp:120,cd:0}};
var secretBoss={spawned:false,defeated:false};
var reflectT=0, cloneT=0;
var powerCD={tp:0,reflect:0,clone:0,ult:0};
var league='Bronce';
var rareCoins=0;
var mutation={fire:0,poison:0,electric:0,form:'none'};
var rep={karma:0,path:'neutral'};
var story={chapter:1,npcMemory:{},mapFlags:{}};
var base={core:1,trophy:0,lab:1,training:1};
var director={pressure:1,assist:0};
var ghost={active:false,x:0,y:0,retrieved:false};
var weekly={goal:3,progress:0,reward:10};
var pvpState={on:false,p2:{x:0,y:0,vx:0,vy:0,hp:120,mhp:120,name:'Rival'}};
var pvpOnline={on:false,room:'',nick:'P'+(Math.random()*999|0),chan:null,sid:'',transport:'none',lastRx:0,connected:false,relayBusy:false};
var lastEndReason='DEFEAT';
var vfxPulse=0, hitFlash=0;

var RARITY={
  normal:{n:'Normal',m:1,col:'#bfc8d8'},
  rare:{n:'Raro',m:1.12,col:'#4da6ff'},
  epic:{n:'Ã‰pico',m:1.25,col:'#b266ff'},
  legendary:{n:'Legendario',m:1.42,col:'#ffd530'},
  mythic:{n:'MÃ­tico',m:1.65,col:'#ff5ccf'}
};

var AVATARS={
  zr7:{name:'ZR7',sub:'Striker elÃ©ctrico',body:'#1f5cff',accent:'#e8f0ff',visor:'#8fd1ff',perk:'jump'},
  nessi:{name:'NESSI',sub:'Maestro Ã¡gil',body:'#18b35d',accent:'#d5ffd6',visor:'#ffe680',perk:'crit'}
};
var selAvatar='zr7';

var AUD={ctx:null,master:null,on:true,unlocked:false};
function initAudio(){
  if(AUD.ctx) return;
  var Ctx=window.AudioContext||window.webkitAudioContext;
  if(!Ctx) return;
  AUD.ctx=new Ctx();
  AUD.master=AUD.ctx.createGain();
  AUD.master.gain.value=.22;
  AUD.master.connect(AUD.ctx.destination);
}
function unlockAudio(){
  if(!AUD.on) return;
  initAudio();
  if(!AUD.ctx) return;
  AUD.ctx.resume();
  AUD.unlocked=true;
}
function sfx(freq,dur,type,vol,slide){
  if(!AUD.on) return;
  initAudio();
  if(!AUD.ctx||AUD.ctx.state==='suspended') return;
  var t=AUD.ctx.currentTime;
  var o=AUD.ctx.createOscillator();
  var g=AUD.ctx.createGain();
  o.type=type||'sine';
  o.frequency.setValueAtTime(freq,t);
  if(slide) o.frequency.exponentialRampToValueAtTime(max(30,freq*slide),t+dur);
  g.gain.setValueAtTime(0.0001,t);
  g.gain.exponentialRampToValueAtTime(vol||.08,t+.01);
  g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.connect(g); g.connect(AUD.master);
  o.start(t); o.stop(t+dur+.02);
}
function noiseHit(vol,dur){
  if(!AUD.on) return;
  initAudio();
  if(!AUD.ctx||AUD.ctx.state==='suspended') return;
  var len=round(AUD.ctx.sampleRate*dur);
  var buf=AUD.ctx.createBuffer(1,len,AUD.ctx.sampleRate);
  var d=buf.getChannelData(0);
  for(var i=0;i<len;i++) d[i]=(Math.random()*2-1)*(1-i/len);
  var src=AUD.ctx.createBufferSource();src.buffer=buf;
  var f=AUD.ctx.createBiquadFilter();f.type='highpass';f.frequency.value=600;
  var g=AUD.ctx.createGain();g.gain.value=vol||.08;
  src.connect(f);f.connect(g);g.connect(AUD.master);src.start();
}
function toggleSfx(){
  AUD.on=!AUD.on;
  var b=document.getElementById('sfxBtn');
  if(b){b.textContent=AUD.on?'SFX ON':'SFX OFF';b.classList.toggle('off',!AUD.on);} 
  if(AUD.on) unlockAudio();
}

function loadMeta(){
  bestScore=+(localStorage.getItem('skywars_best_score')||0);
  bestWave=+(localStorage.getItem('skywars_best_wave')||0);
  try{var pj=localStorage.getItem('skywars_progress');if(pj)prog=Object.assign(prog,JSON.parse(pj));}catch(e){}
  try{var mb=localStorage.getItem('skywars_mode_best');if(mb)modeBest=Object.assign(modeBest,JSON.parse(mb));}catch(e){}
  try{var ak=localStorage.getItem('skywars_ach');if(ak)achieves=JSON.parse(ak);}catch(e){}
  try{var dl=localStorage.getItem('skywars_daily');if(dl)daily=Object.assign(daily,JSON.parse(dl));}catch(e){}
  try{var gr=localStorage.getItem('skywars_global_rank');if(gr)globalRank=JSON.parse(gr);}catch(e){}
  try{var cs=localStorage.getItem('skywars_cosmetics');if(cs)cosmetics=Object.assign(cosmetics,JSON.parse(cs));}catch(e){}
  try{var mt=localStorage.getItem('skywars_mutation');if(mt)mutation=Object.assign(mutation,JSON.parse(mt));}catch(e){}
  try{var rp=localStorage.getItem('skywars_rep');if(rp)rep=Object.assign(rep,JSON.parse(rp));}catch(e){}
  try{var st=localStorage.getItem('skywars_story');if(st)story=Object.assign(story,JSON.parse(st));}catch(e){}
  try{var bs=localStorage.getItem('skywars_base');if(bs)base=Object.assign(base,JSON.parse(bs));}catch(e){}
}


function saveMeta(){
  localStorage.setItem('skywars_best_score',String(bestScore));
  localStorage.setItem('skywars_best_wave',String(bestWave));
  localStorage.setItem('skywars_progress',JSON.stringify(prog));
  localStorage.setItem('skywars_mode_best',JSON.stringify(modeBest));
  localStorage.setItem('skywars_ach',JSON.stringify(achieves));
  localStorage.setItem('skywars_daily',JSON.stringify(daily));
  localStorage.setItem('skywars_global_rank',JSON.stringify(globalRank.slice(0,100)));
  localStorage.setItem('skywars_cosmetics',JSON.stringify(cosmetics));
  localStorage.setItem('skywars_mutation',JSON.stringify(mutation));
  localStorage.setItem('skywars_rep',JSON.stringify(rep));
  localStorage.setItem('skywars_story',JSON.stringify(story));
  localStorage.setItem('skywars_base',JSON.stringify(base));
}


function renderMeta(){
  var t=document.getElementById('titleMeta');
  if(t) t.innerHTML='Best Score <b>'+bestScore.toLocaleString()+'</b> Â· Best Wave <b>'+bestWave+'</b> Â· Mode Best <b>'+(modeBest[selMode]||0).toLocaleString()+'</b>';
  var p=document.getElementById('profileMeta');
  if(p){var need=prog.lvl*100; p.textContent=prog.title+' Â· '+league+' Â· LV '+prog.lvl+' Â· XP '+prog.xp+'/'+need+' Â· Coins '+prog.coins+' Â· Rare '+rareCoins+' Â· Tokens '+prog.tokens+' Â· Pet '+pet.lvl+' Â· SP '+prog.skillPts+' Â· '+rep.path+' Â· Mut:'+mutation.form;}
  var bm=document.getElementById('badgeMeta'); if(bm) bm.textContent='Badges: '+(prog.badges.length?prog.badges.join(', '):'none')+' Â· Top '+globalRank.length;
  var dm=document.getElementById('dailyMeta'); if(dm) dm.textContent='Daily: '+daily.challenge+' '+daily.progress+'/'+daily.goal+' Â· Streak '+daily.streak+'d Â· Map '+mapSet;
}
function addXP(v){
  runXP+=v;
  prog.xp+=v;
  while(prog.xp>=prog.lvl*100){
    prog.xp-=prog.lvl*100; prog.lvl++; prog.tokens++; prog.skillPts++; prog.coins+=5;
    prog.permDmg*=1.05; prog.permSpd*=1.05;
    if(prog.lvl>=3) prog.unlocks.laser=true; if(prog.lvl>=5) prog.unlocks.launcher=true; if(prog.lvl>=7) prog.unlocks.sniper=true;
    if(prog.lvl>=4) prog.unlocks.skinRare=true; if(prog.lvl>=8) prog.unlocks.skinEpic=true; if(prog.lvl>=12) prog.unlocks.skinLegend=true;
    if(prog.lvl>=6&&!prog.badges.includes('Veteran')) prog.badges.push('Veteran');
    if(prog.lvl>=10){prog.title='Elite'; if(!prog.badges.includes('Elite')) prog.badges.push('Elite');}
    announce('LEVEL UP '+prog.lvl+'!'); sfx(520,.2,'triangle',.08,1.4);
  }
}

function checkDaily(){
  var d=(new Date()).toISOString().slice(0,10);
  if(daily.day!==d){
    var prev=daily.day; daily.day=d; daily.progress=0; var dailyPool=[{c:'Mata 200 enemigos',g:200},{c:'Llega a wave 15',g:15},{c:'Mata boss sin recibir daÃ±o',g:1}]; var dsel=pick(dailyPool); daily.challenge=dsel.c; daily.goal=dsel.g; daily.claimed=false;
    if(prev){daily.streak++; if(daily.streak%3===0){prog.tokens+=2; announce('STREAK BONUS +2 TOKENS');}}
  }
}
function gainDaily(type,v){
  if(daily.challenge==='Mata 200 enemigos'&&type==='kill') daily.progress=min(daily.goal,daily.progress+v);
  if(daily.challenge==='Llega a wave 15'&&type==='wave') daily.progress=max(daily.progress,v);
  if(daily.challenge==='Mata boss sin recibir daÃ±o'&&type==='bossnodmg'&&v>0) daily.progress=1;
  if(daily.progress>=daily.goal&&!daily.claimed){daily.claimed=true;prog.tokens+=5;unlockAch('daily_master','Daily Master');announce('DAILY COMPLETE +5 TOKENS');}
}
function unlockAch(k,msg){if(achieves[k])return;achieves[k]=1;announce('ğŸ† '+msg);prog.tokens+=1;}
function updateLeague(){
  var scoreRef=(modeBest.classic||0);
  league=scoreRef>50000?'Oro':scoreRef>15000?'Plata':'Bronce';
}
function updateReputation(v){rep.karma+=v; rep.path=rep.karma>15?'bueno':rep.karma<-15?'corrupto':'neutral';}
function applyMutation(el){mutation[el]++; if(mutation[el]>=18) mutation.form=el+'-master';}
function deepSynergy(){
  if((inventory.relic&&inventory.relic.name==='Storm Capacitor')&&(inventory.artifact&&inventory.artifact.name==='Arc Heart')){superE=min(100,superE+0.3);}
  if((inventory.relic&&inventory.relic.name==='Flame Shell')&&selClass==='demo') runBuffs.dmg*=1.002;
}
function directorAI(){
  var perfScore=(P.hp/P.mhp)+(combo>8?.4:0)+(kills/(wave*8+1));
  director.pressure=clamp(perfScore,.6,1.8);
  director.assist=clamp(1.2-perfScore,0,.7);
}
function selectMapTheme(){
  var maps=['Ciudad destruida','Laboratorio','Desierto','Base militar','Espacio'];
  mapSet=pick(maps);
  mapFx={meteor:0,toxic:0,lowG:0,turret:0};
  if(mapSet==='Ciudad destruida') mapFx.meteor=1;
  if(mapSet==='Laboratorio') mapFx.turret=1;
  if(mapSet==='Desierto') mapFx.toxic=1;
  if(mapSet==='Base militar') mapFx.turret=1;
  if(mapSet==='Espacio') mapFx.lowG=1;
  biome=mapSet;
}
function buildTalentSel(){
  var row=document.getElementById('talentRow'); if(!row) return; row.innerHTML='';
  [{k:'glass',n:'GLASS CANNON'},{k:'adrenaline',n:'ADRENALINE'},{k:'guardian',n:'GUARDIAN'}].forEach(function(t){
    var b=document.createElement('button'); b.className='mode-btn '+(selTalent===t.k?'on':''); b.textContent=t.n; b.onclick=function(){selTalent=t.k;buildTalentSel();}; row.appendChild(b);
  });
}
function buildSkillTree(){
  var row=document.getElementById('skillRow'); if(!row) return; row.innerHTML='';
  [{k:'dmg',n:'DMG'},{k:'spd',n:'SPD'},{k:'crit',n:'CRIT'},{k:'def',n:'DEF'}].forEach(function(sk){
    var b=document.createElement('button'); b.className='skill-btn'; b.textContent=sk.n+' '+prog.skills[sk.k];
    b.classList.toggle('on',prog.skills[sk.k]>0);
    b.onclick=function(){if(prog.skillPts<=0)return;prog.skillPts--;prog.skills[sk.k]++;if(sk.k==='dmg')prog.permDmg*=1.03;if(sk.k==='spd')prog.permSpd*=1.03;if(sk.k==='crit')prog.crit+=.015;if(sk.k==='def')prog.defMul*=.97;renderMeta();buildSkillTree();};
    row.appendChild(b);
  });
}

function rollRarity(){
  var r=Math.random();
  if(r<.45) return 'normal';
  if(r<.73) return 'rare';
  if(r<.90) return 'epic';
  if(r<.98) return 'legendary';
  return 'mythic';
}
function applyItem(it){
  if(it.slot==='relic') inventory.relic=it;
  if(it.slot==='artifact') inventory.artifact=it;
  inventory.items.push(it);
  if(inventory.items.length>14) inventory.items.shift();
}
function trySecretBossUnlock(){
  return !secretBoss.spawned && !secretBoss.defeated && wave>=15 && contracts.done && (prog.badges.includes('Elite')||kills>=120);
}
function buildCoopSel(){
  var row=document.getElementById('coopRow'); if(!row) return; row.innerHTML='';
  var b=document.createElement('button'); b.className='mode-btn '+(coop.on?'on':''); b.textContent='CO-OP LOCAL '+(coop.on?'ON':'OFF');
  b.onclick=function(){coop.on=!coop.on;buildCoopSel();}; row.appendChild(b);
}

function buildSkinSel(){
  var row=document.getElementById('skinRow'); if(!row) return; row.innerHTML='';
  var skins=[{k:'base',n:'SKIN BASE',req:1},{k:'neo',n:'SKIN NEO',req:4},{k:'shadow',n:'SKIN SHADOW',req:8},{k:'gold',n:'SKIN GOLD',req:12}];
  skins.forEach(function(sk){
    var ok=prog.lvl>=sk.req;
    var b=document.createElement('button'); b.className='mode-btn '+(cosmetics.skin===sk.k?'on':'');
    b.textContent=ok?sk.n:(sk.n+' (LV '+sk.req+')');
    b.disabled=!ok;
    b.onclick=function(){if(!ok)return;cosmetics.skin=sk.k;saveMeta();buildSkinSel();};
    row.appendChild(b);
  });
}
function buildAvatarSel(){
  var row=document.getElementById('avatarRow'); if(!row) return; row.innerHTML='';
  Object.keys(AVATARS).forEach(function(k){
    var a=AVATARS[k];
    var b=document.createElement('button'); b.className='mode-btn '+(cosmetics.avatar===k?'on':'');
    b.textContent=a.name+' Â· '+a.sub;
    b.onclick=function(){cosmetics.avatar=k;selAvatar=k;saveMeta();buildAvatarSel();};
    row.appendChild(b);
  });
}

function disconnectOnline(){
  if(pvpOnline.chan){try{pvpOnline.chan.close();}catch(e){} pvpOnline.chan=null;}
  pvpOnline.transport='none'; pvpOnline.connected=false; pvpOnline.sid=''; pvpOnline.relayBusy=false;
}
function onOnlinePacket(d){
  if(!d||d.nick===pvpOnline.nick) return;
  if(d.type==='state'){
    pvpState.p2.x=d.x||pvpState.p2.x; pvpState.p2.y=d.y||pvpState.p2.y;
    pvpState.p2.name=d.nick||'Rival'; if(typeof d.hp==='number') pvpState.p2.hp=d.hp;
    pvpOnline.lastRx=performance.now(); pvpOnline.connected=true;
    return;
  }
  if(d.type==='hit'&&state==='playing'&&selMode==='pvp_online'){
    hurtPlayer(d.dmg||2);
    if(P.hp<=0){sendOnlineState({type:'kill'}); endGame('DEFEAT ONLINE');}
    return;
  }
  if(d.type==='kill'){announce('âš” '+(d.nick||'Rival')+' te derrotÃ³'); endGame('DEFEAT ONLINE');}
}
function connectRelay(room,nick,onFail){
  var m=document.getElementById('onlineMeta');
  fetch('/online/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({room:room,nick:nick})})
  .then(function(r){return r.ok?r.json():Promise.reject();})
  .then(function(j){
    if(!j||!j.sid){onFail();return;}
    pvpOnline.sid=j.sid; pvpOnline.transport='relay'; pvpOnline.connected=true;
    if(m) m.textContent='Online PvP relay: sala '+room+' como '+nick;
  }).catch(function(){onFail();});
}
function connectBroadcast(room,nick){
  var m=document.getElementById('onlineMeta');
  try{pvpOnline.chan=new BroadcastChannel('skywars_online_'+room);}catch(e){pvpOnline.on=false;if(m)m.textContent='Online PvP no soportado';return;}
  pvpOnline.transport='bc';
  pvpOnline.chan.onmessage=function(ev){onOnlinePacket(ev.data||{});};
  if(m)m.textContent='Online PvP local (fallback) sala '+room+' como '+nick;
}
function pollRelay(){
  if(pvpOnline.transport!=='relay'||!pvpOnline.sid||pvpOnline.relayBusy) return;
  pvpOnline.relayBusy=true;
  fetch('/online/poll?room='+encodeURIComponent(pvpOnline.room)+'&sid='+encodeURIComponent(pvpOnline.sid))
    .then(function(r){return r.ok?r.json():{events:[]};})
    .then(function(j){(j.events||[]).forEach(onOnlinePacket);})
    .catch(function(){})
    .finally(function(){pvpOnline.relayBusy=false;});
}
function buildOnlineSel(force){
  var m=document.getElementById('onlineMeta'); if(!m) return;
  var roomEl=document.getElementById('roomInput');
  var nickEl=document.getElementById('nickInput');
  var room=((roomEl&&roomEl.value)||'').trim();
  var nick=((nickEl&&nickEl.value)||'Player').trim().slice(0,14);
  if(!nick) nick='Player';
  pvpOnline.nick=nick;
  if(selMode!=='pvp_online'){m.textContent='Online PvP: offline';return;}
  if(!room){m.textContent='Online PvP: escribe cÃ³digo de sala';return;}
  if(pvpOnline.on&&pvpOnline.room===room&&!force&&pvpOnline.transport!=='none'){m.textContent='Online PvP: sala '+room+' conectada';return;}
  disconnectOnline();
  pvpOnline.room=room; pvpOnline.on=true; pvpOnline.connected=false;
  connectRelay(room,nick,function(){connectBroadcast(room,nick);});
}

function sendOnlineState(extra){
  if(!pvpOnline.on) return;
  var payload=Object.assign({type:'state',nick:pvpOnline.nick,x:P.x,y:P.y,hp:P.hp,ts:Date.now()},extra||{});
  if(pvpOnline.transport==='relay'&&pvpOnline.sid){
    fetch('/online/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({room:pvpOnline.room,sid:pvpOnline.sid,payload:payload})}).catch(function(){});
    return;
  }
  if(pvpOnline.transport==='bc'&&pvpOnline.chan){pvpOnline.chan.postMessage(payload);}
}

function rollCardsAndCurse(){
  deckCards=[pick(['Rapid Fire','Vampiric Rounds','Shock Ammo']),pick(['Combo Engine','Thick Armor','Lucky Drop'])];
  curse={name:pick(['Fragile Hull','Vampiric Enemies','Dark Fog']),active:pct(.45),mult:1.35};
  if(curse.active) announce('â˜  CURSE: '+curse.name+' (x'+curse.mult.toFixed(2)+' rewards)');
}
function updateContracts(){
  var el=document.getElementById('contracts');
  if(el) el.textContent='Contracts: Kills '+contracts.kill+'/'+contracts.target+' Â· Boss '+contracts.boss+'/'+contracts.targetBoss+' Â· Biome '+biome+' Â· Inv '+(inventory.relic?inventory.relic.name:'-')+'/'+(inventory.artifact?inventory.artifact.name:'-');
  if(!contracts.done&&contracts.kill>=contracts.target&&contracts.boss>=contracts.targetBoss){contracts.done=true; prog.tokens+=4; spawnPick(P.x,P.y-35,'weapon'); announce('ğŸ“œ CONTRACT COMPLETE +4 TOKENS');}
}
function updateDynamicMusic(){
  if(!AUD.on||!AUD.ctx||AUD.ctx.state==='suspended') return;
  if(!AUD.bg){AUD.bg=AUD.ctx.createOscillator();AUD.bg.type='triangle';AUD.bgG=AUD.ctx.createGain();AUD.bgG.gain.value=.01;AUD.bg.connect(AUD.bgG);AUD.bgG.connect(AUD.master);AUD.bg.start();}
  var highWave=wave>=12?.4:0;
  var inten=clamp(enemies.length/18 + (bossOn?.8:0) + highWave + (overdriveT>0?.35:0),0,2.2);
  AUD.bg.frequency.setValueAtTime(60+inten*140,AUD.ctx.currentTime);
  AUD.bgG.gain.setTargetAtTime(.008+inten*.035,AUD.ctx.currentTime,.2);
}

function togglePause(){
  if(state!=='playing'&&state!=='paused') return;
  state=state==='playing'?'paused':'playing';
  document.getElementById('pause').classList.toggle('on',state==='paused');
}

/* ---- Camera ---- */
const cam = {x:0,y:0,tx:0,ty:0};

/* ---- Stars ---- */
const stars = Array.from({length:STAR_N},function(){return {
  x:Math.random(), y:Math.random(),
  s:rnd(.4,2.2), b:rnd(.3,1), tw:rnd(.5,3), layer:rnd(.15,.9)
};});

/* ---- Nebulae ---- */
const nebs = Array.from({length:7},function(){return {
  x:rnd(0,1), y:rnd(.03,.45), w:rnd(.12,.3), h:rnd(.06,.18),
  hue:rndI(170,330), a:rnd(.015,.05), dr:rnd(-.00008,.00008)
};});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLATFORMS â€” Solid collision rectangles
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var platforms = [];
var bridges = [];

function genWorld(){
  platforms=[]; bridges=[]; portals=[]; traps=[];
  var gy = H*0.72;
  var n = max(5, min(9, round(W/180)));
  var sp = W/(n+1);
  var ci = floor(n/2);

  for(var i=0;i<n;i++){
    var ic = i===ci;
    var pw = ic ? rnd(220,280) : rnd(110,190);
    var ph = rnd(20,35);
    var px = sp*(i+1) + rnd(-25,25);
    var py = gy + rnd(-50,50);
    var layers = rndI(2,4);
    var hue = ic?210:pick([0,25,120,200,280,340]);
    platforms.push({
      x:px-pw/2, y:py, w:pw, h:ph, cx:px, cy:py,
      layers:layers, hue:hue, isCenter:ic,
      hasChest:!ic&&pct(.35), chestOpened:false, chestType:pick(['ammo','health','shield','weapon']),
      veg: Array.from({length:rndI(1,4)},function(){return {
        off:rnd(.1,.9), type:pick(['tree','crystal','mushroom','flower']),
        sz:rnd(.7,1.3), hue:rndI(80,300)
      };})
    });
  }

  // Bridges
  for(var bi=0;bi<platforms.length-1;bi++){
    var a=platforms[bi], b=platforms[bi+1];
    if(abs(a.cy-b.cy)<70 && pct(.55)){
      bridges.push({x1:a.x+a.w, y1:a.y, x2:b.x, y2:b.y, w:28});
    }
  }

  // Floating platforms
  for(var fi=0;fi<6;fi++){
    var fw=rnd(55,90), fh=rnd(12,20);
    var fx=rnd(80,W-80);
    var fy=gy+rnd(-200,-70);
    platforms.push({
      x:fx-fw/2, y:fy, w:fw, h:fh, cx:fx, cy:fy,
      layers:1, hue:pick([180,280,40]),
      isCenter:false, hasChest:pct(.45), chestOpened:false,
      chestType:pick(['ammo','health','shield','weapon']), veg:[]
    });
  }
  var p1=platforms[0], p2=platforms[platforms.length-1];
  if(p1&&p2){portals.push({x:p1.cx,y:p1.y-18,tx:p2.cx,ty:p2.y-18,biome:pick(['Neon Ruins','Toxic Marsh','Inferno Core'])});}
  for(var ti=0;ti<3;ti++){var tp=pick(platforms);if(tp)traps.push({x:tp.cx+rnd(-20,20),y:tp.y-4,on:false});}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLLISION â€” Proper AABB + one-way platform
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function collidePlatforms(e){
  // e has: x,y (center-bottom), w,h, vx,vy, prevY
  var grounded = false;
  var eLeft = e.x - e.w/2;
  var eRight = e.x + e.w/2;
  var eFeet = e.y;         // bottom of entity
  var ePrevFeet = e.prevY; // bottom last frame

  // Platforms (one-way: land on top only)
  for(var pi=0;pi<platforms.length;pi++){
    var p = platforms[pi];
    var pLeft = p.x;
    var pRight = p.x + p.w;
    var pTop = p.y;

    // Horizontal overlap check
    if(eRight <= pLeft || eLeft >= pRight) continue;

    // One-way platform: only collide when falling through from above
    if(e.vy >= 0 && ePrevFeet <= pTop + 2 && eFeet >= pTop - 2){
      e.y = pTop;
      e.vy = 0;
      grounded = true;
    }
  }

  // Bridges (one-way slope)
  for(var bri=0;bri<bridges.length;bri++){
    var br = bridges[bri];
    var bx1 = min(br.x1,br.x2);
    var bx2 = max(br.x1,br.x2);
    if(e.x < bx1-5 || e.x > bx2+5) continue;
    var t = clamp((e.x-br.x1)/(br.x2-br.x1),0,1);
    var bTop = lerp(br.y1,br.y2,t);
    if(e.vy >= 0 && ePrevFeet <= bTop+2 && eFeet >= bTop-2){
      e.y = bTop;
      e.vy = 0;
      grounded = true;
    }
  }

  e.grounded = grounded;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEAPONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var WEAPS = {
  pistol:  {name:'Pistol',  icon:'ğŸ”«',dmg:14,rate:260,spread:.035,bul:1,spd:20,ammo:Infinity,maxA:Infinity,rld:0,   range:600,col:'#ffe040',sz:3,kb:2},
  smg:     {name:'SMG',     icon:'ğŸ”«',dmg:9, rate:75, spread:.09, bul:1,spd:18,ammo:120,maxA:120,rld:1400,range:420,col:'#28ffb2',sz:2,kb:1},
  shotgun: {name:'Shotgun', icon:'ğŸ’¥',dmg:8, rate:680,spread:.18, bul:7,spd:15,ammo:24, maxA:24, rld:2100,range:280,col:'#ff8830',sz:3,kb:6},
  sniper:  {name:'Sniper',  icon:'ğŸ¯',dmg:60,rate:1100,spread:.004,bul:1,spd:32,ammo:15,maxA:15,rld:2600,range:1100,col:'#ff2d78',sz:4,kb:8},
  launcher:{name:'Launcher',icon:'ğŸš€',dmg:45,rate:1400,spread:.025,bul:1,spd:11,ammo:8, maxA:8, rld:2800,range:500,col:'#ff0060',sz:6,kb:12,expl:true},
  laser:   {name:'Laser',   icon:'âš¡',dmg:4, rate:28, spread:.015,bul:1,spd:42,ammo:200,maxA:200,rld:1800,range:650,col:'#00e8ff',sz:2,kb:.4}
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLASSES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var CLASSES = {
  assault:{name:'Asaltante',icon:'ğŸ”«',desc:'Balanceado',hp:110,sh:55,spd:3.6,jmp:10,weap:['smg','shotgun'],abil:{name:'Burst',icon:'ğŸ’£',cd:8000,key:'Q'},col:'#ff4444'},
  tank:{name:'Tanque',icon:'ğŸ›¡ï¸',desc:'MÃ¡s vida, menos daÃ±o',hp:180,sh:120,spd:2.4,jmp:8,weap:['shotgun','launcher'],abil:{name:'Shield Wall',icon:'ğŸ›¡ï¸',cd:12000,key:'Q'},col:'#44ff44'},
  rapid:{name:'RÃ¡pido',icon:'âš¡',desc:'Velocidad alta, poca vida',hp:78,sh:28,spd:5.0,jmp:11.8,weap:['smg','pistol'],abil:{name:'Dash',icon:'ğŸ’¨',cd:3800,key:'Q'},col:'#00ccff'},
  demo:{name:'Demoliciones',icon:'ğŸ’¥',desc:'Explosivos',hp:105,sh:45,spd:3.4,jmp:9.6,weap:['launcher','shotgun'],abil:{name:'Mega Grenade',icon:'ğŸ§¨',cd:9000,key:'Q'},col:'#ff8830'}
};
var selClass = 'assault';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAYER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var P = {
  x:0,y:0,prevY:0,vx:0,vy:0,w:20,h:36,
  hp:100,mhp:100,sh:50,msh:50,
  spd:3.6,jmp:10,grounded:false,
  weaps:[],wi:0,lastFire:0,reloading:false,rldStart:0,
  abilLast:-1e5,invuln:0,
  facing:1,anim:0,
  shieldWall:false,shieldT:0,
  focus:false,focusT:0,
  canDJ:true
};

/* â”€â”€ Entity pools â”€â”€ */
var bullets=[], enemies=[], particles=[], pickups=[], explosions=[], turrets=[], grenades=[];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTICLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function emitP(x,y,n,col,speed,life,sz){
  for(var i=0;i<n;i++){
    var a=rnd(0,TAU), s=rnd(speed*.3,speed);
    particles.push({x:x,y:y,vx:cos(a)*s,vy:sin(a)*s-rnd(0,1.5),life:life,ml:life,col:col,sz:rnd(sz*.5,sz*1.5),g:rnd(.04,.18),fr:rnd(.95,.99)});
  }
}

function explode(x,y,r,dmg){
  if(inventory.relic&&inventory.relic.name==='Flame Shell') r*=1.25;
  explosions.push({x:x,y:y,r:r,mr:r,life:18,ml:18});
  emitP(x,y,28,'#ff6622',6,30,4);
  emitP(x,y,14,'#ffcc00',4,20,3);
  emitP(x,y,8,'#ff2200',3,24,5);
  shake=8;
  for(var ei=0;ei<enemies.length;ei++){
    var e=enemies[ei];
    if(e.dead) continue;
    var d=dst(x,y,e.x,e.y-e.h/2);
    if(d<r) hurtEnemy(e,dmg*(1-d/r),x);
  }
  var pd=dst(x,y,P.x,P.y-P.h/2);
  if(pd<r && P.invuln<=0) hurtPlayer(dmg*.25*(1-pd/r));
}

/* â”€â”€ Damage numbers â”€â”€ */
function showDmg(x,y,v,crit){
  var el=document.createElement('div');
  el.className='dmg';
  el.textContent=round(v);
  el.style.left=(x-cam.x+W/2)+'px';
  el.style.top=(y-cam.y+H/2-20)+'px';
  el.style.fontSize=crit?'20px':'13px';
  el.style.color=crit?'#ffd530':'#fff';
  el.style.textShadow=crit?'0 0 10px #ffd530':'0 0 4px rgba(255,255,255,.5)';
  document.body.appendChild(el);
  setTimeout(function(){el.remove();},800);
}

function showFloat(x,y,txt,col){
  var el=document.createElement('div');
  el.className='ft'; el.textContent=txt;
  el.style.left=x+'px'; el.style.top=y+'px';
  el.style.color=col; el.style.textShadow='0 0 10px '+col;
  document.body.appendChild(el);
  setTimeout(function(){el.remove();},1200);
}

function addKill(txt){
  var f=document.getElementById('killfeed');
  var el=document.createElement('div');
  el.className='kf'; el.textContent=txt;
  f.appendChild(el);
  setTimeout(function(){el.remove();},3500);
  while(f.children.length>5) f.removeChild(f.firstChild);
}

function announce(txt){
  var el=document.getElementById('wannounce');
  el.textContent=txt; el.classList.add('on');
  setTimeout(function(){el.classList.remove('on');},2500);
}

function activateOverdrive(){
  overdriveT=360;
  sfx(260,.2,'sawtooth',.08,1.8);
  sfx(420,.22,'triangle',.06,.6);
  announce('âš¡ OVERDRIVE ACTIVATED');
  emitP(P.x,P.y-P.h/2,18,'#00e8ff',4,24,3);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMBAT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hurtPlayer(raw){
  noiseHit(.1,.1); hitFlash=1;
  if(P.invuln>0||P.shieldWall) return;
  var d=round(raw*prog.defMul*(1+prog.skills.def*-0.02));
  if(P.sh>0){var sd=min(P.sh,d);P.sh-=sd;d-=sd;}
  P.hp-=d; P.invuln=18; shake=max(shake,3);
  emitP(P.x,P.y-P.h/2,4,'#ff0000',3,12,3);
  if(P.hp<=0){
    if(!ghost.active&&!ghost.retrieved){ghost.active=true;ghost.x=P.x;ghost.y=P.y;P.hp=max(1,round(P.mhp*.35));announce('ğŸ‘» Ghost state: recover your body!');}
    else {P.hp=0;endGame('DEFEAT');}
  }
}

function hurtEnemy(e,raw){
  sfx(210,.06,'square',.04,.72);
  var crit=pct(.12);
  var d=round(crit?raw*2:raw);
  e.hp-=d; e.flash=8; dmgDealt+=d;
  showDmg(e.x,e.y-e.h,d,crit); if(crit){vfxPulse=min(1,vfxPulse+.35);emitP(e.x,e.y-e.h/2,16,'#ffd530',4,16,3);shake=max(shake,6);}
  if(raw>0){var w=P.weaps[P.wi]||{}; if(w.col&&w.col.indexOf('ff88')>=0) applyMutation('fire'); if(w.col&&w.col.indexOf('66e0')>=0) applyMutation('electric');}
  emitP(e.x,e.y-e.h/2,4,e.col||'#ff4466',3,12,2);
  if((e.boss||e.miniBoss)&&!e.phase2&&e.hp<e.mhp*.60){e.phase2=true;e.spd*=1.2;e.dmg=round(e.dmg*1.25);e.col='#ff0055';announce('â˜  '+e.name+' PHASE II');slowT=12;slowF=.45;sfx(140,.2,'sawtooth',.09,1.9);}
  if((e.boss||e.miniBoss)&&e.phase2&&!e.phase3&&e.hp<e.mhp*.25){e.phase3=true;e.spd*=1.25;e.dmg=round(e.dmg*1.35);e.aRate*=.7;e.col='#ffd530';announce('â˜  '+e.name+' PHASE III');slowT=10;slowF=.4;sfx(90,.26,'sawtooth',.1,2.1);}
  if(e.hp<=0) killE(e,crit);
}

function killE(e,crit){
  e.dead=true; kills++; enKilled++; contracts.kill++; gainDaily('kill',1); if(e.boss||e.miniBoss){contracts.boss++; gainDaily('bossnodmg',P.hp===P.mhp?1:0);} 
  combo+=runBuffs.combo; comboT=140; maxCombo=max(maxCombo,combo);
  var base=e.boss?650:e.miniBoss?260:e.elite?100:25;
  var dcfg=DIFFS[selDiff];
  var odMul=overdriveT>0?1.35:1;
  score+=round(base*(1+combo*.1)*dcfg.scoreMul*odMul);
  var xpGain=(e.boss?85:e.miniBoss?45:e.elite?22:10)+(crit?8:0)+(e.special==='gold'?10:0); if(eventState.name.indexOf('DOBLE XP')>=0) xpGain*=2; addXP(xpGain); weekly.progress+=1; updateReputation(e.boss?2:1);
  emitP(e.x,e.y-e.h/2,22,e.col||'#ff4466',5,28,3);
  vfxPulse=min(1,vfxPulse+.22);
  sfx(150,.09,'triangle',.05,1.7);
  emitP(e.x,e.y-e.h/2,10,'#ffcc00',3,18,2);
  addKill(e.boss?'BOSS '+e.tname+' DESTROYED':e.elite?'Elite '+e.tname+' eliminated':e.tname+' eliminated');
  if(combo===8&&overdriveT<=0) activateOverdrive();
  if(combo>2) showFloat(W/2,H/2-60,combo+'x COMBO!','#ff2d78');
  if(eventState.exploders||e.ai==='suicide'){explode(e.x,e.y,70,20);}
  if(pct(.35)) spawnPick(e.x,e.y,pick(['health','ammo','shield']));
  if(e.boss||e.miniBoss){ if(e.name==='VOID EMPEROR'){secretBoss.defeated=true;unlockAch('void_emperor','Void Emperor Defeated');prog.title='Apex';prog.coins+=50;} 
    spawnPick(e.x-30,e.y,'health');spawnPick(e.x+30,e.y,'shield');spawnPick(e.x,e.y-20,'weapon');
    bossOn=false;bossRef=null;document.getElementById('bossbar').style.display='none';
  }
  if(enKilled>=enThisWave){
    var r=pct(.05)?'legendary':pct(.2)?'epic':pct(.45)?'rare':'common';
    if(r==='legendary'||combo>=20||kills%40===0) spawnPick(P.x+rnd(-40,40),P.y-30,'weapon');
    prog.coins+=r==='legendary'?12:r==='epic'?7:r==='rare'?4:2;
    if(r==='legendary') announce('ğŸ’° LEGENDARY CHEST');
    if(e.boss){slowT=24;slowF=.35;emitP(e.x,e.y,30,'#ffd530',5,24,4);}
    setTimeout(nextWave,2200);
  } 
}

/* â”€â”€ Pickups â”€â”€ */
function spawnPick(x,y,type){
  pickups.push({x:x,y:y-10,type:type,life:700,bob:rnd(0,TAU),got:false});
}
function collectPick(p){
  p.got=true;
  var cols={health:'#ff4444',ammo:'#ffd530',shield:'#2080ff',weapon:'#b040ff'};
  emitP(p.x,p.y,10,cols[p.type]||'#fff',3,18,2);
  if(p.type==='health'){P.hp=min(P.mhp,P.hp+30);showFloat(W/2,H/2,'+30 HP','#ff4444');}
  else if(p.type==='ammo'){var w=P.weaps[P.wi];if(w)w.ammo=w.maxA;showFloat(W/2,H/2,'AMMO FULL','#ffd530');}
  else if(p.type==='shield'){P.sh=min(P.msh,P.sh+25);showFloat(W/2,H/2,'+25 SHIELD','#2080ff');}
  else if(p.type==='weapon'){
    var av=Object.keys(WEAPS).filter(function(k){return k!=='pistol'&&!P.weaps.some(function(ww){return ww.type===k;});});
    if(av.length){
      var wt=pick(av),wd=WEAPS[wt];
      var rr=rollRarity(), rv=RARITY[rr];
      var newWeap={type:wt,name:wd.name+' ['+rv.n+']',icon:wd.icon,dmg:wd.dmg*rv.m,rate:wd.rate*(rr==='mythic'?0.86:1),spread:wd.spread,bul:wd.bul,spd:wd.spd,ammo:wd.maxA,maxA:wd.maxA,rld:wd.rld,range:wd.range,col:rv.col||wd.col,sz:wd.sz+(rr==='legendary'||rr==='mythic'?1:0),kb:wd.kb,rarity:rr};
      if(wd.expl) newWeap.expl=true;
      P.weaps.push(newWeap);
      if(pct(.35)){applyItem({slot:'relic',name:pick(['Impact Core','Storm Capacitor','Flame Shell'])});}
      if(pct(.22)){applyItem({slot:'artifact',name:pick(['Chrono Lens','Titan Plate','Arc Heart'])});}
      showFloat(W/2,H/2,'+ '+newWeap.name.toUpperCase(),'#b040ff');
      buildWBar();
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENEMY FACTORY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var ETYPES = {
  grunt:  {tname:'Grunt',  w:18,h:28,col:'#ff4466',hp:30, spd:1.6,dmg:9, aRng:32, aRate:800, ai:'chase',jc:.015},
  shooter:{tname:'Shooter',w:18,h:30,col:'#ff8830',hp:25, spd:1.2,dmg:11,aRng:340,aRate:1200,ai:'ranged',jc:.01},
  bomber: {tname:'Bomber', w:20,h:24,col:'#ff0044',hp:40, spd:2.6,dmg:38,aRng:38, aRate:1e6, ai:'suicide',jc:.04},
  flying: {tname:'Flyer',  w:20,h:20,col:'#b040ff',hp:22, spd:2.1,dmg:13,aRng:240,aRate:1400,ai:'flying',jc:0},
  heavy:  {tname:'Heavy',  w:26,h:36,col:'#4488ff',hp:85, spd:.8, dmg:22,aRng:38, aRate:1100,ai:'chase',jc:.004},
  ninja:  {tname:'Ninja',  w:16,h:28,col:'#28ffb2',hp:26, spd:3.6,dmg:16,aRng:33, aRate:550, ai:'chase',jc:.07},
  healer: {tname:'Healer', w:18,h:28,col:'#66ffcc',hp:34, spd:1.7,dmg:7,aRng:250,aRate:1500,ai:'healer',jc:.01},
  summoner:{tname:'Summoner',w:20,h:30,col:'#c266ff',hp:52, spd:1.4,dmg:9,aRng:280,aRate:2600,ai:'summoner',jc:.01}
};

function mkEnemy(type,x,y,elite,boss){
  var dcfg=DIFFS[selDiff];
  var hm=(1+(wave-1)*.15)*dcfg.hpMul, dm=(1+(wave-1)*.1)*dcfg.dmgMul;
  var em=elite?2:1, bm=boss?5:1;
  var t=ETYPES[type]||ETYPES.grunt;
  var special='none';
  if(wave>=3&&pct(.08)) special=pick(['gold','phantom','tank','sniper']);
  var spd=t.spd*(selMode==='speed'?2:1)*(selMode==='chaos'?1.35:1), hpM=1, dmgM=(selMode==='chaos'?1.25:1), ai=t.ai, col=t.col, name=t.tname;
  if(special==='gold'){hpM*=1.35;dmgM*=1.2;col='#ffd530';name='Golden '+name;}
  if(special==='phantom'){hpM*=.92;dmgM*=1.25;col='rgba(180,220,255,.45)';name='Phantom '+name;}
  if(special==='tank'){hpM*=1.85;spd*=.85;col='#6aa4ff';name='Titan '+name;}
  if(special==='sniper'){dmgM*=1.35;ai='ranged';col='#ff66cc';name='Sniper '+name;}
  return {
    x:x,y:y,prevY:y,vx:0,vy:0,
    w:t.w,h:t.h,col:col,spd:spd,dmg:round(t.dmg*dm*em*bm*dmgM),
    aRng:t.aRng,aRate:t.aRate,ai:ai,jc:t.jc,tname:name,
    hp:round(t.hp*hm*em*bm*hpM),mhp:round(t.hp*hm*em*bm*hpM),
    grounded:false,lastAtk:0,flash:0,dead:false,
    elite:elite,boss:boss,miniBoss:false,phase2:false,special:special,name:boss?'OMEGA '+name.toUpperCase():name,
    anim:0,ait:0,tgtX:x,tgtY:y
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WAVES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var spawnTimer=null;
function nextWave(){
  sfx(180,.18,'triangle',.06,1.4);
  wave++; enKilled=0;
  var base=4+wave*2;
  var isSecret=trySecretBossUnlock();
  var isBoss=wave%10===0||isSecret, isMini=wave%5===0&&!isBoss;
  enThisWave=(isBoss||isMini)?min(base+1,MAX_ENEMIES):min(base,MAX_ENEMIES);
  announce(isSecret?'â˜  FINAL SECRET BOSS â˜ ':(isBoss?'âš  WAVE '+wave+' â€” BOSS âš ':(isMini?'âš  WAVE '+wave+' â€” MINI BOSS âš ':'WAVE '+wave)));
  rollEvent(); gainDaily('wave',wave);
  if(wave%3===0&&selMode!=='hardcore'&&shopWaveLock!==wave){shopWaveLock=wave;openShop();return;}
  directorAI();
  spawnWaveNow();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ABILITIES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function useAbil(){
  var now=performance.now();
  var cls=CLASSES[selClass];
  if(now-P.abilLast<cls.abil.cd) return;
  P.abilLast=now;
  if(selClass==='assault'){grenades.push({x:P.x,y:P.y-15,vx:P.facing*9,vy:-7,timer:95,dmg:70,r:120});}
  else if(selClass==='rapid'){P.vx=P.facing*22;P.invuln=18;emitP(P.x,P.y,16,'#00ccff',4,18,3); if((inventory.relic&&inventory.relic.name==='Impact Core')||runBuffs.spd>1.2){for(var i=0;i<enemies.length;i++){var e=enemies[i];if(!e.dead&&dst(P.x,P.y,e.x,e.y)<70) hurtEnemy(e,32);}}}
  else if(selClass==='tank'){P.shieldWall=true;P.shieldT=220;P.sh=P.msh;emitP(P.x,P.y,20,'#44ff44',3,22,3);}
  else if(selClass==='demo'){grenades.push({x:P.x,y:P.y-15,vx:P.facing*8,vy:-8,timer:75,dmg:95,r:145});emitP(P.x,P.y,14,'#ff8830',4,16,3);}
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHOOTING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function shoot(){
  var now=performance.now();
  var w=P.weaps[P.wi]; if(!w) return;
  if(P.reloading) return;
  var fireMul=overdriveT>0?.68:1;
  if(now-P.lastFire<w.rate*fireMul) return;
  if(w.ammo<=0&&isFinite(w.maxA)){startReload();return;}
  sfx(320,.045,'square',.022,.78);
  P.lastFire=now;
  if(isFinite(w.maxA)) w.ammo--;
  var ba=ang(P.x,P.y-P.h/2,mWorld.x,mWorld.y);
  var sm=P.focus?.08:1;
  for(var i=0;i<w.bul;i++){
    var a=ba+rnd(-w.spread,w.spread)*sm;
    var dmg=w.dmg*runBuffs.dmg*prog.permDmg*(1+prog.skills.dmg*.02);
    if((inventory.relic&&inventory.relic.name==='Storm Capacitor')&&stormT>0) dmg*=1.35;
    if(w.expl&&(inventory.relic&&inventory.relic.name==='Flame Shell')) dmg*=1.22;
    bullets.push({x:P.x+P.facing*12,y:P.y-P.h/2,vx:cos(a)*w.spd,vy:sin(a)*w.spd,
      dmg:dmg,life:ceil(w.range/w.spd),col:(cosmetics.bulletFx==='arc'||w.rarity==='mythic'?'#66e0ff':w.col),sz:w.sz+(cosmetics.bulletFx==='arc'||w.rarity==='legendary'||w.rarity==='mythic'?1:0),fri:true,expl:w.expl,kb:w.kb,rarity:w.rarity});
  }
  emitP(P.x+P.facing*14,P.y-P.h/2,4,w.col,3,8,2);
  P.vx-=P.facing*(w.kb||1)*.25;
  shake=max(shake,w.kb*.25);
  if(w.ammo<=0&&isFinite(w.maxA)) startReload();
  buildWBar();
}

function startReload(){
  var w=P.weaps[P.wi];
  if(!w||P.reloading||!isFinite(w.maxA)) return;
  P.reloading=true; P.rldStart=performance.now();sfx(95,.08,'sawtooth',.04,1.9);
  setTimeout(function(){if(P.reloading){w.ammo=w.maxA;P.reloading=false;buildWBar();}},w.rld);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENEMY AI
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function aiUpdate(e){
  if(e.dead) return;
  var tx=P.x, ty=P.y;
  if(coop.on&&pct(.25)){tx=coop.ally.x;ty=coop.ally.y;}
  if(turrets.length&&pct(.2)){tx=turrets[0].x;ty=turrets[0].y;}
  var dx=tx-e.x, dy=ty-e.y, d=hypot(dx,dy);
  var now=performance.now();
  e.anim+=.15; if(e.flash>0) e.flash--;

  var dir=dx>0?1:-1;
  switch(e.ai){
    case 'chase': case 'suicide':
      var hpRatio=e.hp/e.mhp;
      var flee=hpRatio<.18&&e.ai!=='suicide';
      var side=sin((e.ait+(e.w*7))*0.08);
      e.vx=lerp(e.vx,(flee?-dir:dir)*e.spd + side*0.35*e.spd,.12); if(pct(.01)) e.vx+=pick([-1,1])*e.spd*1.2;
      if(e.grounded&&(pct(e.jc)||(e.y>P.y+40&&pct(.025)))) {e.vy=-9;e.grounded=false;}
      if(e.ai==='suicide'&&d<e.aRng){explode(e.x,e.y,90,e.dmg);e.hp=0;e.dead=true;enKilled++;if(enKilled>=enThisWave)setTimeout(nextWave,2200);}
      else if(e.ai==='chase'&&d<e.aRng&&now-e.lastAtk>e.aRate){e.lastAtk=now;hurtPlayer(e.dmg);}
      break;
    case 'ranged':
      if(d<140) e.vx=lerp(e.vx,-dir*e.spd,.06);
      e.vx+=sin(e.ait*.12)*0.06*e.spd;
      if(pct(.018)) e.vx+=pick([-1,1])*e.spd*1.4;
      else if(d>380) e.vx=lerp(e.vx,dir*e.spd,.06);
      else e.vx*=.94;
      if(e.grounded&&pct(e.jc)){e.vy=-8;e.grounded=false;}
      if(d<e.aRng&&now-e.lastAtk>e.aRate){
        e.lastAtk=now;
        var ra=ang(e.x,e.y-e.h/2,P.x,P.y-P.h/2)+rnd(-.1,.1);
        bullets.push({x:e.x,y:e.y-e.h/2,vx:cos(ra)*9,vy:sin(ra)*9,dmg:e.dmg,life:55,col:e.col,sz:3,fri:false,kb:2});
      }
      break;
    case 'healer':
      e.vx*=.9;
      if(now-e.lastAtk>e.aRate){
        e.lastAtk=now;
        var healed=0;
        for(var hi=0;hi<enemies.length;hi++){var h=enemies[hi]; if(h.dead||h===e) continue; if(dst(e.x,e.y,h.x,h.y)<220&&h.hp<h.mhp){h.hp=min(h.mhp,h.hp+18); emitP(h.x,h.y-h.h/2,6,'#66ffcc',2,10,2); healed++; if(healed>=2) break;}}
      }
      break;
    case 'summoner':
      e.vx*=.92;
      if(now-e.lastAtk>e.aRate&&enemies.length<MAX_ENEMIES){
        e.lastAtk=now;
        enemies.push(mkEnemy(pick(['grunt','ninja']),e.x+rnd(-30,30),e.y-10,false,false));
        emitP(e.x,e.y-e.h/2,10,'#c266ff',3,14,2);
      }
      break;
    case 'flying':
      var fy=P.y-90+sin(e.ait*.025)*35;
      e.vx=lerp(e.vx,dir*e.spd,.04);
      e.vy=lerp(e.vy,(fy-e.y)*.025,.06);
      e.grounded=false;
      if(d<e.aRng&&now-e.lastAtk>e.aRate){
        e.lastAtk=now;
        var fa=ang(e.x,e.y,P.x,P.y)+rnd(-.12,.12);
        bullets.push({x:e.x,y:e.y,vx:cos(fa)*8,vy:sin(fa)*8,dmg:e.dmg,life:48,col:'#b040ff',sz:3,fri:false,kb:1});
      }
      break;
  }
  if((e.boss||e.miniBoss)&&e.phase2&&e.ait%90===0){
    var n=e.phase3?10:6;
    for(var bi=0;bi<n;bi++){var ba=bi/n*TAU;bullets.push({x:e.x,y:e.y-e.h/2,vx:cos(ba)*(e.phase3?9:7),vy:sin(ba)*(e.phase3?9:7),dmg:e.dmg*.7,life:34,col:e.phase3?'#ffd530':'#ff3355',sz:3,fri:false,kb:1});}
    shake=max(shake,4); sfx(120,.12,'sawtooth',.07,1.5);
  }
  e.ait++;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var keys={};
var mWorld={x:0,y:0};
var mDown=false;

addEventListener('keydown',function(ev){
  var k=ev.key.toLowerCase(); keys[k]=true;
  if(k===' '||k==='arrowup'||k==='arrowdown'||k==='escape') ev.preventDefault();
  if(k==='escape'||k==='p'){togglePause();return;}
  if(state==='playing'){
    if(k==='r') startReload();
    if(k==='q') useAbil();
    if(k>='1'&&k<='5'){var idx=+k-1;if(idx<P.weaps.length){P.wi=idx;P.reloading=false;buildWBar();}}
    if(k==='e') interact();
    if(k==='z') useSuper('nova');
    if(k==='x') useSuper('chrono');
    if(k==='c') useSuper('storm');
    if(k==='v') usePower('tp');
    if(k==='b') usePower('reflect');
    if(k==='n') usePower('clone');
    if(k==='m') usePower('ult');
    if(k==='g') craftFusion();
  }
});
addEventListener('keyup',function(ev){keys[ev.key.toLowerCase()]=false;});

C.addEventListener('mousemove',function(ev){
  mWorld.x=ev.clientX+cam.x-W/2;
  mWorld.y=ev.clientY+cam.y-H/2;
  P.facing=mWorld.x>P.x?1:-1;
});
C.addEventListener('mousedown',function(ev){mDown=true;ev.preventDefault();});
C.addEventListener('mouseup',function(){mDown=false;});
C.addEventListener('contextmenu',function(ev){ev.preventDefault();});

function interact(){
  var pi,pl;
  for(pi=0;pi<portals.length;pi++){var po=portals[pi];if(dst(P.x,P.y,po.x,po.y)<60){P.x=po.tx;P.y=po.ty;biome=po.biome;announce('PORTAL â†’ '+biome);return;}}
  for(pi=0;pi<traps.length;pi++){var tr=traps[pi];if(dst(P.x,P.y,tr.x,tr.y)<55&&!tr.on){tr.on=true;announce('Trap Activated');emitP(tr.x,tr.y,14,'#ffd530',3,18,3);return;}}
  for(pi=0;pi<pickups.length;pi++){var p=pickups[pi];if(!p.got&&dst(P.x,P.y,p.x,p.y)<50){collectPick(p);return;}}
  for(pi=0;pi<platforms.length;pi++){
    pl=platforms[pi];
    if(pl.hasChest&&!pl.chestOpened&&dst(P.x,P.y,pl.cx,pl.cy-12)<65){
      pl.chestOpened=true;spawnPick(pl.cx,pl.cy-18,pl.chestType);emitP(pl.cx,pl.cy-18,12,'#ffd530',4,22,3);return;
    }
  }
}

/* â”€â”€ Mobile â”€â”€ */
var joyAct=false,jDX=0,jDY=0;
var jThumb=document.getElementById('joyThumb');
var jArea=document.getElementById('joyArea');
var mobFire=false;

if(jArea){
  jArea.addEventListener('touchstart',function(ev){joyAct=true;ev.preventDefault();},{passive:false});
  jArea.addEventListener('touchmove',function(ev){
    if(!joyAct)return;
    var r=jArea.getBoundingClientRect();
    var cx=r.left+r.width/2, cy=r.top+r.height/2;
    var dx=ev.touches[0].clientX-cx, dy=ev.touches[0].clientY-cy;
    var mx=48, d=hypot(dx,dy);
    if(d>mx){dx=dx/d*mx;dy=dy/d*mx;}
    jDX=dx/mx;jDY=dy/mx;
    jThumb.style.transform='translate(calc(-50% + '+dx+'px),calc(-50% + '+dy+'px))';
    ev.preventDefault();
  },{passive:false});
  var endJ=function(){joyAct=false;jDX=0;jDY=0;jThumb.style.transform='translate(-50%,-50%)';};
  jArea.addEventListener('touchend',endJ);jArea.addEventListener('touchcancel',endJ);
}
var mFireB=document.getElementById('m-fire');
var mJumpB=document.getElementById('m-jump');
var mAbilB=document.getElementById('m-abil');
var mRlB=document.getElementById('m-rl');
var mSwB=document.getElementById('m-sw');

if(mFireB){
  mFireB.addEventListener('touchstart',function(ev){mobFire=true;ev.preventDefault();},{passive:false});
  mFireB.addEventListener('touchend',function(){mobFire=false;});
  mFireB.addEventListener('touchcancel',function(){mobFire=false;});
}
if(mJumpB){mJumpB.addEventListener('touchstart',function(ev){keys[' ']=true;ev.preventDefault();},{passive:false});mJumpB.addEventListener('touchend',function(){keys[' ']=false;});}
if(mAbilB){mAbilB.addEventListener('touchstart',function(ev){useAbil();ev.preventDefault();},{passive:false});}
if(mRlB){mRlB.addEventListener('touchstart',function(ev){startReload();ev.preventDefault();},{passive:false});}
if(mSwB){mSwB.addEventListener('touchstart',function(ev){P.wi=(P.wi+1)%P.weaps.length;P.reloading=false;buildWBar();ev.preventDefault();},{passive:false});}

function autoAim(){
  var cl=null,cd=Infinity;
  for(var i=0;i<enemies.length;i++){var e=enemies[i];if(e.dead)continue;var d=dst(P.x,P.y,e.x,e.y);if(d<cd){cd=d;cl=e;}}
  return cl;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI BUILDERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSuperUI(){
  var row=document.getElementById('superSlots'); if(!row) return; row.innerHTML='';
  ['nova','chrono','storm'].forEach(function(k){
    var d=SUPERS[k];
    var cd=max(0,superCD[k]-performance.now()/1000);
    var el=document.createElement('div');
    el.className='sp-slot '+(cd<=0&&superE>=d.cost?'ready':'');
    el.innerHTML=d.name+' <span class="k">['+d.key+'] '+(cd>0?cd.toFixed(1)+'s':d.cost+'E')+'</span>';
    el.style.borderColor=cd<=0&&superE>=d.cost?d.col:'';
    el.style.color=cd<=0&&superE>=d.cost?d.col:'';
    row.appendChild(el);
  });
}

function useSuper(kind){
  if(state!=='playing') return;
  var d=SUPERS[kind]; if(!d) return;
  var now=performance.now()/1000;
  if(superE<d.cost||superCD[kind]>now) return;
  superE-=d.cost; superCD[kind]=now+d.cd;
  if(kind==='nova'){
    explode(P.x,P.y-P.h/2,170,70);
    bullets=bullets.filter(function(b){if(!b.fri&&dst(b.x,b.y,P.x,P.y-P.h/2)<180){emitP(b.x,b.y,3,'#ff8830',2,10,2);return false;}return true;});
    sfx(130,.2,'sawtooth',.09,2.2);
    announce('â˜„ SOLAR NOVA');
  }
  else if(kind==='chrono'){
    chronoT=360;
    sfx(520,.2,'triangle',.08,.55);
    announce('ğŸ•’ CHRONO FREEZE');
  }
  else if(kind==='storm'){
    stormT=420; stormTick=0;
    sfx(240,.22,'square',.08,1.8);
    announce('âš¡ ARC STORM');
  }
  if(uiTick%8===0) buildSuperUI();
}

function usePower(k){
  var now=performance.now()/1000;
  if(powerCD[k]&&powerCD[k]>now) return;
  if(k==='tp'){powerCD.tp=now+7;P.x=clamp(P.x+P.facing*130,30,W-30);emitP(P.x,P.y,18,'#66e0ff',3,16,2);}
  if(k==='reflect'){powerCD.reflect=now+16;reflectT=180;announce('Reflect Shield');}
  if(k==='clone'){powerCD.clone=now+20;cloneT=360;announce('Combat Clone');}
  if(k==='ult'){powerCD.ult=now+45;overdriveT=max(overdriveT,420);slowT=120;slowF=.6;announce('ULTIMATE MODE');}
}
function craftFusion(){
  if(P.weaps.length<2) return;
  var a=P.weaps[0],b=P.weaps[1];
  var nm='Fusion '+a.name.split(' ')[0]+'-'+b.name.split(' ')[0];
  var rr='mythic',rv=RARITY[rr];
  var nw={type:'fusion',name:nm,icon:'â˜„',dmg:(a.dmg+b.dmg)*0.8*rv.m,rate:min(a.rate,b.rate)*.85,spread:(a.spread+b.spread)/2,bul:max(a.bul,b.bul),spd:max(a.spd,b.spd),ammo:120,maxA:120,rld:1700,range:max(a.range,b.range),col:rv.col,sz:max(a.sz,b.sz)+1,kb:max(a.kb,b.kb),rarity:rr,expl:true};
  P.weaps=[nw].concat(P.weaps.slice(2)); P.wi=0; buildWBar(); announce('WEAPON FUSION READY');
}

function buildClsSel(){
  var g=document.getElementById('clsGrid');g.innerHTML='';
  Object.keys(CLASSES).forEach(function(k){
    var c=CLASSES[k];
    var d=document.createElement('div');
    d.className='cls '+(k===selClass?'sel':'');
    d.innerHTML='<div class="cls-i">'+c.icon+'</div><div class="cls-n">'+c.name+'</div><div class="cls-d">'+c.desc+'</div>';
    d.addEventListener('click',function(){selClass=k;document.querySelectorAll('.cls').forEach(function(el){el.classList.remove('sel');});d.classList.add('sel');});
    g.appendChild(d);
  });
}

function buildDiffSel(){
  var row=document.getElementById('diffRow');
  var desc=document.getElementById('diffDesc');
  if(!row||!desc) return;
  row.innerHTML='';
  Object.keys(DIFFS).forEach(function(k){
    var d=DIFFS[k];
    var b=document.createElement('button');
    b.className='diff-btn '+(k===selDiff?'on':'');
    b.textContent=d.name;
    b.style.borderColor=k===selDiff?d.col:'';
    b.style.color=k===selDiff?d.col:'';
    b.addEventListener('click',function(){selDiff=k;buildDiffSel();});
    row.appendChild(b);
  });
  desc.textContent=DIFFS[selDiff].desc;
}

function buildModeSel(){
  var row=document.getElementById('modeRow'); if(!row) return; row.innerHTML='';
  Object.keys(MODES).forEach(function(k){
    var m=MODES[k];
    var b=document.createElement('button'); b.className='mode-btn '+(k===selMode?'on':''); b.textContent=m.name;
    b.addEventListener('click',function(){selMode=k;buildModeSel();renderMeta();if(selMode!=='pvp_online'){disconnectOnline();pvpOnline.on=false;}var om=document.getElementById('onlineMeta');if(om)om.textContent=selMode==='pvp_online'?'Online PvP: ingresa usuario + cÃ³digo y conecta':'Online PvP: offline';}); row.appendChild(b);
  });
}
function openShop(){
  state='shop'; shopPending=true;
  var el=document.getElementById('shop'); el.classList.add('on');
  var grid=document.getElementById('shopGrid'); grid.innerHTML='';
  var pool=[
    {n:'MaldiciÃ³n Poderosa',d:'+45% daÃ±o / -25% vida',buy:function(){runBuffs.dmg*=1.45;P.mhp*=.75;P.hp=min(P.hp,P.mhp);updateReputation(-2);}},
    {n:'+20% Damage',d:'Temporal por 2 oleadas',buy:function(){runBuffs.dmg*=1.2;}},
    {n:'+15% Speed',d:'Movilidad mejorada',buy:function(){runBuffs.spd*=1.15;}},
    {n:'+40 Shield',d:'Escudo instantÃ¡neo',buy:function(){P.sh=min(P.msh+40,P.sh+40);runBuffs.shield+=40;}},
    {n:'Weapon Upgrade',d:'Mejora el arma activa',buy:function(){var w=P.weaps[P.wi];if(w){w.dmg*=1.25;w.rate*=.9;}}},
    {n:'Double Combo',d:'Combo x2 por 1 oleada',buy:function(){runBuffs.combo=2;setTimeout(function(){runBuffs.combo=1;},90000);}}
  ];
  var opts=[];while(opts.length<3&&pool.length){opts.push(pool.splice(rndI(0,pool.length-1),1)[0]);}
  opts.forEach(function(o){var d=document.createElement('button');d.className='shop-it';d.innerHTML=o.n+'<small>'+o.d+'</small>';d.onclick=function(){o.buy();el.classList.remove('on');state='playing';shopPending=false;spawnWaveNow();};grid.appendChild(d);});
}
function spawnWaveNow(){
  var isBoss=wave%5===0, isMini=wave%3===0&&!isBoss, sc=0;
  if(spawnTimer) clearInterval(spawnTimer);
  spawnTimer=setInterval(function(){
    if(state!=='playing'){clearInterval(spawnTimer);return;}
    if(sc>=enThisWave){clearInterval(spawnTimer);return;}
    var sp=pick(platforms.filter(function(p){return !p.isCenter;}));
    var sx=sp?sp.cx+rnd(-sp.w/4,sp.w/4):rnd(100,W-100);
    var sy=sp?sp.y-50:H*.45;
    if((isBoss||isMini)&&sc===enThisWave-1){
      var bt=pick(isBoss?['heavy','grunt','shooter']:['heavy','ninja','shooter']);
      var b=mkEnemy(bt,sx,sy,isMini,false);
      if(isBoss){b.boss=true;b.w*=1.7;b.h*=1.7;b.name='OMEGA '+b.tname.toUpperCase(); if(trySecretBossUnlock()){b.mhp=round(b.mhp*2.2);b.hp=b.mhp;b.dmg=round(b.dmg*1.8);b.name='VOID EMPEROR';secretBoss.spawned=true;}}
      if(isMini){b.miniBoss=true;b.w*=1.35;b.h*=1.35;b.name='ALPHA '+b.tname.toUpperCase();}
      enemies.push(b);bossOn=true;bossRef=b;
      document.getElementById('bossbar').style.display='block'; document.getElementById('bossN').textContent=b.name;
    } else {
      var avail=['grunt']; if(wave>=2)avail.push('shooter');if(wave>=3)avail.push('bomber');if(wave>=4)avail.push('flying');if(wave>=5)avail.push('heavy');if(wave>=6)avail.push('ninja');if(wave>=7)avail.push('healer');if(wave>=8)avail.push('summoner');
      var eliteChance=clamp(.12+wave*.02+DIFFS[selDiff].eliteBonus,.05,.55);
      enemies.push(mkEnemy(pick(avail),sx,sy,wave>=3&&pct(eliteChance),false));
    }
    sc++;
  },round(550*DIFFS[selDiff].spawnMul/(selMode==='chaos'?1.35:1)/director.pressure));
}
function rollEvent(){
  eventState={name:'',t:0,meteor:0,storm:0,toxic:0,exploders:0};
  if(!pct(.4)) return;
  var ev=pick(['meteor','storm','toxic','legend','exploders','invasion','dark','doublexp','giant','vendor']);
  if(ev==='meteor'){eventState={name:'ğŸŒ  METEOR RAIN',t:420,meteor:1,storm:0,toxic:0};}
  if(ev==='storm'){eventState={name:'âš¡ ELECTRIC STORM',t:420,meteor:0,storm:1,toxic:0};}
  if(ev==='toxic'){eventState={name:'ğŸŒ« TOXIC ZONE',t:420,meteor:0,storm:0,toxic:1};}
  if(ev==='legend'){spawnPick(P.x+rnd(-120,120),P.y-40,'weapon');announce('ğŸ’ LEGENDARY DROP');return;}
  if(ev==='exploders'){eventState={name:'ğŸ’¥ VOLATILE ENEMIES',t:360,meteor:0,storm:0,toxic:0,exploders:1};}
  if(ev==='invasion'){eventState={name:'ğŸ§Ÿ INVASIÃ“N MASIVA',t:420,meteor:0,storm:0,toxic:0,exploders:0};for(var i=0;i<6;i++) enemies.push(mkEnemy('grunt',P.x+rnd(-260,260),P.y-60,false,false));}
  if(ev==='dark'){eventState={name:'ğŸŒ‘ ZONA OSCURA',t:420,meteor:0,storm:0,toxic:1,exploders:0};}
  if(ev==='doublexp'){eventState={name:'âœ¨ DOBLE XP',t:420,meteor:0,storm:0,toxic:0,exploders:0};}
  if(ev==='giant'){eventState={name:'ğŸ—¿ ENEMIGOS GIGANTES',t:320,meteor:0,storm:0,toxic:0,exploders:0};for(var gi=0;gi<enemies.length;gi++){enemies[gi].w*=1.12;enemies[gi].h*=1.12;}}
  if(ev==='vendor'){prog.coins+=5;announce('ğŸ§ª VENDEDOR MISTERIOSO +5 COINS');}

  announce(eventState.name);
}
function buildWBar(){
  var bar=document.getElementById('wbar');bar.innerHTML='';
  P.weaps.forEach(function(w,i){
    var s=document.createElement('div');
    s.className='ws '+(i===P.wi?'on':'');
    var ammoTxt=isFinite(w.maxA)?'<span class="wa">'+w.ammo+'</span>':'';
    s.innerHTML='<span class="wk">'+(i+1)+'</span><span class="wi">'+w.icon+'</span>'+ammoTxt;
    s.addEventListener('click',function(){P.wi=i;P.reloading=false;buildWBar();});
    bar.appendChild(s);
  });
}

function buildAbilUI(){
  var u=document.getElementById('abil');
  var c=CLASSES[selClass];
  u.innerHTML='<div class="ab" id="abMain">'+c.abil.icon+'<span class="ak">'+c.abil.key+'</span></div>';
}

function updHUD(){
  document.getElementById('hpBar').style.width=(P.hp/P.mhp*100)+'%';
  document.getElementById('shBar').style.width=(P.sh/P.msh*100)+'%';
  document.getElementById('hpLbl').textContent=ceil(P.hp)+' / '+ceil(P.sh);
  document.getElementById('waveLbl').textContent='WAVE '+wave;
  var extra=(selMode==='timeattack'?' Â· '+modeTimeLeft.toFixed(1)+'s':'')+(eventState.t>0?' Â· '+eventState.name:'');
  document.getElementById('eLbl').textContent=max(0,enThisWave-enKilled)+' HOSTILES'+extra;
  document.getElementById('scoreLbl').textContent=score.toLocaleString();
  document.getElementById('killLbl').textContent='KILLS '+kills;
  document.getElementById('superEFill').style.width=superE+'%';
  document.getElementById('xpBar').style.width=(prog.xp/(prog.lvl*100)*100)+'%';
  var odTxt=overdriveT>0?' Â· âš¡ '+(overdriveT/60).toFixed(1)+'s':'';
  document.getElementById('comboLbl').textContent=(combo>1?combo+'x COMBO':'')+odTxt;

  buildSuperUI();

  // Ability CD
  var now=performance.now();
  var cls=CLASSES[selClass];
  var cdL=max(0,cls.abil.cd-(now-P.abilLast));
  var abEl=document.getElementById('abMain');
  if(abEl){
    var ov=abEl.querySelector('.cd');
    if(cdL>0){
      if(!ov){ov=document.createElement('div');ov.className='cd';abEl.appendChild(ov);}
      ov.textContent=ceil(cdL/1000);
    } else if(ov) ov.remove();
  }

  // Boss
  if(bossOn&&bossRef&&!bossRef.dead){
    document.getElementById('bossF').style.width=(bossRef.hp/bossRef.mhp*100)+'%';
  }

  // Reload bar
  if(P.reloading){
    var rw=P.weaps[P.wi];
    if(rw){
      var rpct=min(1,(performance.now()-P.rldStart)/rw.rld);
      var act=document.querySelector('.ws.on');
      if(act){
        var rb=act.querySelector('.reload-bar');
        if(!rb){rb=document.createElement('div');rb.className='reload-bar';act.appendChild(rb);}
        rb.style.width=(rpct*100)+'%';
      }
    }
  } else {
    document.querySelectorAll('.reload-bar').forEach(function(el){el.remove();});
  }
}

/* â”€â”€ Minimap â”€â”€ */
var mmC=document.getElementById('minimap');
var mmX=mmC.getContext('2d');
function drawMinimap(){
  mmC.width=120;mmC.height=120;
  mmX.clearRect(0,0,120,120);
  mmX.fillStyle='rgba(0,0,0,.4)';mmX.fillRect(0,0,120,120);
  var sc=120/max(W*1.2,H*1.2);
  var ox=60-cam.x*sc, oy=60-cam.y*sc;
  var mi;
  for(mi=0;mi<platforms.length;mi++){
    var p=platforms[mi];
    mmX.fillStyle='hsla('+p.hue+',55%,35%,.5)';
    mmX.fillRect(ox+p.x*sc,oy+p.y*sc,p.w*sc,3);
  }
  for(mi=0;mi<enemies.length;mi++){
    var e=enemies[mi];
    if(e.dead)continue;
    mmX.fillStyle=e.boss?'#ff0000':e.elite?'#ff8830':'#ff4466';
    mmX.fillRect(ox+e.x*sc-1,oy+e.y*sc-1,3,3);
  }
  mmX.fillStyle='#00e8ff';
  mmX.beginPath();mmX.arc(ox+P.x*sc,oy+P.y*sc,3,0,TAU);mmX.fill();
  for(mi=0;mi<pickups.length;mi++){
    var pk=pickups[mi];
    if(pk.got)continue;
    mmX.fillStyle=pk.type==='health'?'#ff4444':pk.type==='shield'?'#2080ff':'#ffd530';
    mmX.fillRect(ox+pk.x*sc-1,oy+pk.y*sc-1,2,2);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDERING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawSky(){
  var g=X.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#030510');g.addColorStop(.25,'#08061e');
  g.addColorStop(.55,'#150c38');g.addColorStop(1,'#251258');
  X.fillStyle=g;X.fillRect(0,0,W,H);
}

function drawStars(t){
  for(var i=0;i<stars.length;i++){
    var s=stars[i];
    var px=s.layer*.3;
    var sx=((s.x*W*2-cam.x*px)%W+W)%W;
    var sy=((s.y*H*1.4-cam.y*px*.3)%(H*.8)+H*.8)%(H*.8);
    var tw=.5+.5*sin(t*.001*s.tw);
    X.fillStyle='rgba(255,255,255,'+(s.b*tw)+')';
    X.beginPath();X.arc(sx,sy,s.s,0,TAU);X.fill();
  }
}

function drawNebs(t){
  for(var i=0;i<nebs.length;i++){
    var n=nebs[i];
    var nx=((n.x+n.dr*t)%1+1)%1;
    var sx=nx*W, sy=n.y*H;
    var g=X.createRadialGradient(sx,sy,0,sx,sy,n.w*W);
    g.addColorStop(0,'hsla('+n.hue+',75%,45%,'+(n.a*1.4)+')');
    g.addColorStop(.5,'hsla('+n.hue+',55%,28%,'+n.a+')');
    g.addColorStop(1,'transparent');
    X.fillStyle=g;
    X.fillRect(sx-n.w*W,sy-n.h*H,n.w*W*2,n.h*H*2);
  }
}

function drawPlatform(p){
  var px=p.x-cam.x+W/2, py=p.y-cam.y+H/2;

  // Under-glow
  var gw=p.w*.6;
  var gl=X.createRadialGradient(px+p.w/2,py+5,0,px+p.w/2,py+5,gw);
  gl.addColorStop(0,'hsla('+p.hue+',55%,45%,.06)');gl.addColorStop(1,'transparent');
  X.fillStyle=gl;X.fillRect(px+p.w/2-gw,py-gw*.3,gw*2,gw*.8);

  // Layers
  for(var l=p.layers-1;l>=0;l--){
    var lw=p.w-l*14, lh=p.h+l*10;
    var lx=px+(p.w-lw)/2;
    var lt=28-l*5;
    X.fillStyle='hsl('+p.hue+',38%,'+lt+'%)';
    X.beginPath();
    X.moveTo(lx,py);X.lineTo(lx-6,py+lh);X.lineTo(lx+lw+6,py+lh);X.lineTo(lx+lw,py);
    X.closePath();X.fill();
  }

  // Top surface
  X.fillStyle='hsl('+p.hue+',48%,34%)';
  X.fillRect(px,py-3,p.w,7);
  X.fillStyle='hsl('+p.hue+',58%,44%)';
  X.fillRect(px+3,py-3,p.w-6,3);

  // Grass
  var sH=p.hue>60&&p.hue<180?p.hue:120;
  for(var gi=0;gi<p.w/7;gi++){
    var gx=px+gi*7+rnd(0,3);
    X.strokeStyle='hsla('+sH+',65%,'+(38+rnd(0,20))+'%,.5)';
    X.lineWidth=1;X.beginPath();X.moveTo(gx,py-3);X.lineTo(gx+rnd(-3,3),py-3-rnd(3,10));X.stroke();
  }

  // Vegetation
  for(var vi=0;vi<p.veg.length;vi++){
    var v=p.veg[vi];
    var vx=px+v.off*p.w, vy=py-4;
    if(v.type==='tree'){
      X.fillStyle='hsl(30,38%,22%)';X.fillRect(vx-2,vy-16*v.sz,4,16*v.sz);
      X.fillStyle='hsl('+v.hue+',55%,32%)';X.beginPath();X.arc(vx,vy-20*v.sz,9*v.sz,0,TAU);X.fill();
    } else if(v.type==='crystal'){
      X.fillStyle='hsla('+v.hue+',75%,55%,.75)';
      X.beginPath();X.moveTo(vx,vy-14*v.sz);X.lineTo(vx-4*v.sz,vy);X.lineTo(vx+4*v.sz,vy);X.closePath();X.fill();
      X.fillStyle='hsla('+v.hue+',75%,75%,.25)';
      X.beginPath();X.moveTo(vx,vy-14*v.sz);X.lineTo(vx-1,vy);X.lineTo(vx+2*v.sz,vy);X.closePath();X.fill();
    } else if(v.type==='mushroom'){
      X.fillStyle='hsl(0,0%,65%)';X.fillRect(vx-1,vy-7*v.sz,2,7*v.sz);
      X.fillStyle='hsl('+v.hue+',65%,45%)';X.beginPath();X.arc(vx,vy-7*v.sz,4.5*v.sz,PI,0);X.fill();
    } else {
      X.strokeStyle='hsl(120,55%,38%)';X.lineWidth=1.5;X.beginPath();X.moveTo(vx,vy);X.lineTo(vx,vy-9*v.sz);X.stroke();
      X.fillStyle='hsl('+v.hue+',75%,55%)';X.beginPath();X.arc(vx,vy-9*v.sz,2.8*v.sz,0,TAU);X.fill();
    }
  }

  // Chest
  if(p.hasChest){
    var cx=px+p.w/2, cy=py-6;
    if(!p.chestOpened){
      X.fillStyle='#8B6914';X.fillRect(cx-8,cy-8,16,12);
      X.fillStyle='#D4A017';X.fillRect(cx-2,cy-5,4,4);
      X.strokeStyle='#B8860B';X.lineWidth=1;X.strokeRect(cx-8,cy-8,16,12);
    } else {
      X.fillStyle='#5a4010';X.fillRect(cx-8,cy-3,16,7);
      X.fillStyle='#7a5a20';X.fillRect(cx-8,cy-9,16,6);
    }
  }
}

function drawBridge(b){
  var x1=b.x1-cam.x+W/2,y1=b.y1-cam.y+H/2,x2=b.x2-cam.x+W/2,y2=b.y2-cam.y+H/2;
  X.strokeStyle='rgba(140,90,45,.5)';X.lineWidth=b.w;X.lineCap='round';
  X.beginPath();X.moveTo(x1,y1);X.lineTo(x2,y2);X.stroke();
  var steps=ceil(dst(x1,y1,x2,y2)/11);
  X.strokeStyle='rgba(110,70,35,.7)';X.lineWidth=2;
  var ba=ang(x1,y1,x2,y2)+PI/2;
  for(var i=0;i<=steps;i++){
    var t=i/steps;
    var bpx=lerp(x1,x2,t),bpy=lerp(y1,y2,t);
    X.beginPath();X.moveTo(bpx+cos(ba)*11,bpy+sin(ba)*11);X.lineTo(bpx-cos(ba)*11,bpy-sin(ba)*11);X.stroke();
  }
}

function drawPlayer(t){
  var sx=P.x-cam.x+W/2, sy=P.y-cam.y+H/2;
  X.save();X.translate(sx,sy);

  if(P.shieldWall){
    X.strokeStyle='rgba(68,255,68,'+(0.3+sin(t*.01)*.12)+')';X.lineWidth=3;
    X.beginPath();X.arc(0,-P.h/2,P.w+8,0,TAU);X.stroke();
  }
  if(P.focus){
    X.strokeStyle='rgba(255,0,170,'+(0.35+sin(t*.02)*.15)+')';X.lineWidth=2;
    X.beginPath();X.arc(0,-P.h/2,P.w+5,0,TAU);X.stroke();
  }
  if(P.invuln>0&&floor(P.invuln/3)%2===0) X.globalAlpha=.45;

  var f=P.facing;
  var cls=CLASSES[selClass];

  // Body
  var skinCols={base:cls.col,neo:'#00e8ff',shadow:'#7f6bff',gold:'#ffd530'};
  var av=AVATARS[cosmetics.avatar]||AVATARS.zr7;
  X.fillStyle=skinCols[cosmetics.skin]||av.body||cls.col;
  X.beginPath();
  X.moveTo(-P.w/2,-P.h);X.lineTo(-P.w/2+2,0);X.lineTo(P.w/2-2,0);X.lineTo(P.w/2,-P.h);
  X.closePath();X.fill();

  // Accent stripe
  X.fillStyle=av.accent||'rgba(255,255,255,.08)';
  X.fillRect(-P.w/2+2,-P.h+4,4,P.h-8);

  // Head
  X.fillStyle='#eeddcc';X.beginPath();X.arc(0,-P.h-5,8,0,TAU);X.fill();

  // Helmet
  X.fillStyle=skinCols[cosmetics.skin]||av.body||cls.col;
  X.beginPath();X.arc(0,-P.h-5,8,PI,0);X.fill();

  // Visor
  X.fillStyle=av.visor||'#00ddff';X.fillRect(f*2,-P.h-8,f*8,3.5);

  // Weapon arm
  var w=P.weaps[P.wi];
  if(w){
    var aa=ang(0,-P.h*.5,mWorld.x-P.x,mWorld.y-P.y+P.h*.5);
    X.save();X.translate(f*6,-P.h*.55);X.rotate(aa);
    X.fillStyle='#777';X.fillRect(0,-2,16,4);
    X.fillStyle=w.col||'#fff';X.fillRect(13,-3,5,5);
    X.restore();
  }

  // Legs
  var lo=P.grounded?sin(P.anim)*4:3;
  X.fillStyle='#444';
  X.fillRect(-5,-1,4,5+lo);X.fillRect(2,-1,4,5-lo);

  // Jetpack
  if(!P.grounded&&P.vy<-1){
    X.fillStyle='rgba(255,'+(80+rnd(0,175))+',0,'+(0.5+rnd(0,.4))+')';
    X.beginPath();X.moveTo(-5,0);X.lineTo(0,7+rnd(0,10));X.lineTo(5,0);X.fill();
  }

  X.globalAlpha=1;
  X.restore();
}

function drawEnemyFn(e,t){
  if(e.dead)return;
  var sx=e.x-cam.x+W/2, sy=e.y-cam.y+H/2;
  X.save();X.translate(sx,sy);

  // Elite glow
  if(e.elite){
    X.strokeStyle='rgba(255,200,0,'+(0.25+sin(t*.005)*.12)+')';X.lineWidth=2;
    X.beginPath();X.arc(0,-e.h/2,max(e.w,e.h)*.7,0,TAU);X.stroke();
  }
  // Boss glow
  if(e.boss){
    X.strokeStyle='rgba(255,30,60,'+(0.35+sin(t*.003)*.15)+')';X.lineWidth=3;
    X.beginPath();X.arc(0,-e.h/2,max(e.w,e.h)*.85,0,TAU);X.stroke();
  }

  if(e.special==='phantom'&&e.flash<=0) X.globalAlpha=.35+.25*sin(t*.01);
  X.fillStyle=e.flash>0?'#fff':e.col;

  // Body
  X.beginPath();
  X.moveTo(-e.w/2,-e.h);X.lineTo(-e.w/2+1,0);X.lineTo(e.w/2-1,0);X.lineTo(e.w/2,-e.h);
  X.closePath();X.fill();

  var ed=P.x>e.x?1:-1;
  if(e.ai==='flying'){
    X.fillStyle='#ff00ff';X.beginPath();X.arc(ed*3,-e.h*.7,3,0,TAU);X.fill();
    X.fillStyle='hsla(280,75%,50%,'+(0.45+sin(t*.02)*.25)+')';
    X.beginPath();X.ellipse(-e.w*.8,-e.h*.6,7,12,sin(t*.02)*.3,0,TAU);X.fill();
    X.beginPath();X.ellipse(e.w*.8,-e.h*.6,7,12,-sin(t*.02)*.3,0,TAU);X.fill();
  } else if(e.ai==='suicide'){
    X.fillStyle=(floor(t/180)%2===0)?'#ff0000':'#ff8800';
    X.beginPath();X.arc(0,-e.h*.7,3.5,0,TAU);X.fill();
  } else {
    X.fillStyle='#fff';X.fillRect(ed*2-2,-e.h*.8,4,4);
    X.fillStyle='#f00';X.fillRect(ed*3-1,-e.h*.78,2,2);
  }

  // HP bar (elite/boss)
  if(e.elite||e.boss){
    var bw=e.w*1.6;
    X.fillStyle='rgba(0,0,0,.45)';X.fillRect(-bw/2,-e.h-10,bw,4);
    X.fillStyle=e.boss?'#ff2244':'#ffaa00';X.fillRect(-bw/2,-e.h-10,bw*(e.hp/e.mhp),4);
  }

  // Legs
  var elo=e.grounded?sin(e.anim)*3:2;
  X.fillStyle='rgba(0,0,0,.35)';
  X.fillRect(-4,-1,3,4+elo);X.fillRect(2,-1,3,4-elo);

  X.restore();
}

function drawBullets(){
  for(var i=0;i<bullets.length;i++){
    var b=bullets[i];
    var sx=b.x-cam.x+W/2, sy=b.y-cam.y+H/2;
    X.fillStyle=b.col||'#ffe040';
    if(!perf.low){X.shadowColor=b.col||'#ffe040';X.shadowBlur=5;}
    X.beginPath();X.arc(sx,sy,b.sz,0,TAU);X.fill();
    X.shadowBlur=0;
    if(!perf.low){X.globalAlpha=.25;X.strokeStyle=b.col||'#ffe040';X.lineWidth=b.sz*.4;X.beginPath();X.moveTo(sx,sy);X.lineTo(sx-b.vx*2,sy-b.vy*2);X.stroke();X.globalAlpha=1;}
  }
}

function drawPickups(t){
  for(var i=0;i<pickups.length;i++){
    var p=pickups[i];
    if(p.got)continue;
    var sx=p.x-cam.x+W/2, sy=p.y-cam.y+H/2+sin(t*.003+p.bob)*5;
    var icons={health:'â¤ï¸',ammo:'ğŸ”¶',shield:'ğŸ›¡ï¸',weapon:'âš¡'};
    var cols={health:'#ff4444',ammo:'#ffd530',shield:'#2080ff',weapon:'#b040ff'};
    X.fillStyle=cols[p.type]||'#fff';
    X.globalAlpha=.12+sin(t*.005)*.05;
    X.beginPath();X.arc(sx,sy,16,0,TAU);X.fill();
    X.globalAlpha=1;
    X.font='15px sans-serif';X.textAlign='center';X.fillText(icons[p.type]||'?',sx,sy+5);
  }
}

function drawParticles(){
  for(var i=0;i<particles.length;i+=(perf.low?3:1)){
    var p=particles[i];
    var sx=p.x-cam.x+W/2, sy=p.y-cam.y+H/2;
    X.fillStyle=p.col;X.globalAlpha=p.life/p.ml;
    X.beginPath();X.arc(sx,sy,p.sz*(p.life/p.ml),0,TAU);X.fill();
  }
  X.globalAlpha=1;
}

function drawExplosions(){
  for(var i=0;i<explosions.length;i++){
    var e=explosions[i];
    var sx=e.x-cam.x+W/2, sy=e.y-cam.y+H/2;
    var prog=1-e.life/e.ml, r=e.mr*prog;
    X.globalAlpha=1-prog;
    var g=X.createRadialGradient(sx,sy,0,sx,sy,r);
    g.addColorStop(0,'rgba(255,200,50,.75)');g.addColorStop(.3,'rgba(255,100,20,.45)');
    g.addColorStop(.6,'rgba(255,50,0,.15)');g.addColorStop(1,'transparent');
    X.fillStyle=g;X.beginPath();X.arc(sx,sy,r,0,TAU);X.fill();
    X.globalAlpha=1;
  }
}

function drawTurrets(t){
  for(var i=0;i<turrets.length;i++){
    var tu=turrets[i];
    var sx=tu.x-cam.x+W/2, sy=tu.y-cam.y+H/2;
    X.fillStyle='#555';X.fillRect(sx-10,sy-13,20,13);
    X.fillStyle='#777';X.fillRect(sx-8,sy-17,16,5);
    var aim=0,tgt=null,cd=tu.range;
    for(var ei=0;ei<enemies.length;ei++){var e=enemies[ei];if(e.dead)continue;var d=dst(tu.x,tu.y,e.x,e.y);if(d<cd){cd=d;tgt=e;}}
    if(tgt) aim=ang(tu.x,tu.y-10,tgt.x,tgt.y-tgt.h/2);
    X.save();X.translate(sx,sy-14);X.rotate(aim);
    X.fillStyle='#ffaa00';X.fillRect(0,-2,14,4);X.restore();
    X.fillStyle='rgba(0,0,0,.4)';X.fillRect(sx-11,sy-21,22,3);
    X.fillStyle='#ffaa00';X.fillRect(sx-11,sy-21,22*(tu.hp/tu.mhp),3);
  }
}

function drawGrenades(){
  for(var i=0;i<grenades.length;i++){
    var g=grenades[i];
    var sx=g.x-cam.x+W/2, sy=g.y-cam.y+H/2;
    X.fillStyle='#444';X.beginPath();X.arc(sx,sy,5,0,TAU);X.fill();
    X.fillStyle=(g.timer<30&&floor(g.timer/4)%2===0)?'#ff0000':'#222';
    X.beginPath();X.arc(sx,sy-3,2,0,TAU);X.fill();
  }
}

function drawVignette(){
  if(P.hp<P.mhp*.3){
    var a=.12+(1-P.hp/(P.mhp*.3))*.18;
    var g=X.createRadialGradient(W/2,H/2,W*.3,W/2,H/2,W*.7);
    g.addColorStop(0,'transparent');g.addColorStop(1,'rgba(180,0,0,'+a+')');
    X.fillStyle=g;X.fillRect(0,0,W,H);
  }
}

function drawVoidFog(){
  var gy=H*.72;
  var vy=gy+120-cam.y+H/2;
  if(vy<H+120){
    var g=X.createLinearGradient(0,vy,0,vy+250);
    g.addColorStop(0,'transparent');g.addColorStop(1,'rgba(0,0,0,.85)');
    X.fillStyle=g;X.fillRect(0,vy,W,H-vy+250);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN UPDATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function update(){
  if(state!=='playing') return;
  pvpState.on=(selMode==='pvp'||selMode==='pvp_online');
  frameN++; uiTick++;
  updateDynamicMusic();

  // Slow-mo
  if(slowT>0){slowT--;if(slowT<=0){slowF=1;P.focus=false;}}
  var tm=slowF;
  if(selMode==='timeattack'){modeTimeLeft=max(0,modeTimeLeft-1/60); if(modeTimeLeft<=0){announce('TIME UP'); endGame('TIME UP'); return;}}

  // Combo decay
  if(comboT>0){comboT--;if(comboT<=0)combo=0;}
  if(overdriveT>0) overdriveT--;
  if(reflectT>0) reflectT--;
  if(cloneT>0) cloneT--;
  if(chronoT>0) chronoT--;
  if(stormT>0) stormT--;
  if(superE<100) superE=min(100,superE+.045+(combo>0?.03:0));

  // Shield wall
  if(P.shieldWall){P.shieldT--;if(P.shieldT<=0)P.shieldWall=false;}
  if(P.focus&&P.focusT>0)P.focusT--;

  // ---- Player Movement ----
  var mx=0;
  if(keys.a||keys.arrowleft) mx-=1;
  if(keys.d||keys.arrowright) mx+=1;
  if(joyAct) mx+=jDX;
  if(pvpOnline.on&&frameN%5===0){sendOnlineState(); if(frameN%15===0) pollRelay(); var om=document.getElementById('onlineMeta'); if(om&&performance.now()-pvpOnline.lastRx>6000){om.textContent='Online PvP '+(pvpOnline.transport==='relay'?'relay':'local')+': esperando rival en '+pvpOnline.room+'...';}}
  if(pvpState.on){
    var p2=pvpState.p2;
    var mx2=(keys.j?-1:0)+(keys.l?1:0);
    p2.vx=lerp(p2.vx,mx2*P.spd,.2);
    if(keys.i&&p2.y>=P.y-2) p2.vy=-P.jmp;
    p2.vy+=GRAV; p2.vx*=.9; p2.x=clamp((p2.x||P.x+120)+p2.vx,30,W-30); p2.y=(p2.y||P.y)+p2.vy; if(p2.y>P.y) {p2.y=P.y; p2.vy=0;}
    if(mDown&&dst(P.x,P.y,p2.x,p2.y)<42){p2.hp-=2; if(pvpOnline.on) sendOnlineState({type:'hit',dmg:2}); if(p2.hp<=0){if(pvpOnline.on) sendOnlineState({type:'kill'}); announce('P1 WINS PVP'); endGame('VICTORY'); return;}}
  }

  var spdMul=(overdriveT>0?1.22:1)*runBuffs.spd*(eventState.toxic?0.72:1)*prog.permSpd;
  P.vx=lerp(P.vx, mx*P.spd*spdMul, P.grounded?.25:.12);

  // Jump
  if(keys[' ']||keys.arrowup||(joyAct&&jDY<-.5)){
    if(P.grounded){
      P.vy=-P.jmp; P.grounded=false; P.canDJ=true;
      emitP(P.x,P.y,5,'#aaa',2,10,2);
    } else if(P.canDJ&&selClass==='scout'){
      P.vy=-P.jmp*.78; P.canDJ=false;
      emitP(P.x,P.y,8,'#00ccff',3,14,2);
    }
    keys[' ']=false;
  }

  // Store prev position for collision
  P.prevY = P.y;

  // Apply physics
  P.vy += GRAV*tm*(mapFx.lowG?0.65:1);
  P.vx *= .92;
  P.x += P.vx*tm;
  P.y += P.vy*tm;

  // Collide with platforms
  collidePlatforms(P);

  // World bounds X
  P.x = clamp(P.x, 30, W-30);

  // Anim
  if(abs(P.vx)>.4&&P.grounded){P.anim+=.16; if(cosmetics.trail!=='none'&&frameN%3===0) emitP(P.x,P.y,2,cosmetics.trail==='arc'?'#66e0ff':'#ff66aa',1.2,10,1.5);}

  // Void death
  if(P.y > H*.72 + VOID_DEPTH) hurtPlayer(P.hp+P.sh+1);

  // Invuln
  if(P.invuln>0) P.invuln--;

  // Shooting
  if(mDown||mobFire){
    if(mobFire&&!mDown){
      var tgt=autoAim();
      if(tgt){mWorld.x=tgt.x;mWorld.y=tgt.y-tgt.h/2;P.facing=tgt.x>P.x?1:-1;}
    }
    shoot();
  }

  // ---- Bullets ----
  if(bullets.length>260) bullets.splice(0,bullets.length-260);
  bullets=bullets.filter(function(b){
    b.x+=b.vx*tm; b.y+=b.vy*tm; b.life--;
    if(b.life<=0) return false;
    var bi;
    if(b.fri){
      for(bi=0;bi<enemies.length;bi++){
        var e=enemies[bi];
        if(e.dead)continue;
        if(b.x>e.x-e.w/2&&b.x<e.x+e.w/2&&b.y>e.y-e.h&&b.y<e.y){
          if(b.expl) explode(b.x,b.y,85,b.dmg);
          else{hurtEnemy(e,b.dmg);e.vx+=(b.kb||1)*(b.vx>0?1:-1);}
          emitP(b.x,b.y,3,b.col,2,10,2);return false;
        }
      }
    } else {
      if(b.x>P.x-P.w/2&&b.x<P.x+P.w/2&&b.y>P.y-P.h&&b.y<P.y){
        if(reflectT>0){bullets.push({x:b.x,y:b.y,vx:-b.vx*1.1,vy:-b.vy*1.1,dmg:b.dmg*1.4,life:40,col:'#66e0ff',sz:3,fri:true,kb:2});emitP(b.x,b.y,6,'#66e0ff',2,12,2);}
        else {hurtPlayer(b.dmg);emitP(b.x,b.y,4,'#ff0000',3,12,2);}
        return false;
      }
      // Hit turrets
      for(bi=0;bi<turrets.length;bi++){
        var tu=turrets[bi];
        if(dst(b.x,b.y,tu.x,tu.y-7)<14){tu.hp-=b.dmg;emitP(b.x,b.y,3,'#ffaa00',2,8,2);return false;}
      }
    }
    return true;
  });

  // ---- Enemies ----
  if(enemies.length>52) enemies.splice(0,enemies.length-52);
  enemies=enemies.filter(function(e){
    if(e.dead) return false;
    aiUpdate(e);
    e.prevY=e.y;
    var etm=tm*(chronoT>0?.45:1);
    if(e.ai!=='flying') e.vy+=GRAV*etm;
    e.vx*=.91;
    e.x+=e.vx*etm;
    e.y+=e.vy*etm;
    if(e.ai!=='flying') collidePlatforms(e);
    // Fallen off
    if(e.y>H*.72+VOID_DEPTH+200){
      e.dead=true;enKilled++;
      if(enKilled>=enThisWave) setTimeout(nextWave,2200);
      return false;
    }
    return true;
  });

  if(stormT>0){
    stormTick++;
    if(stormTick%24===0){
      var hits=0;
      for(var si=0;si<enemies.length&&hits<3;si++){
        var se=enemies[si]; if(se.dead) continue;
        if(dst(P.x,P.y-20,se.x,se.y-se.h/2)<340){
          hurtEnemy(se,22+combo*1.2);
          emitP(se.x,se.y-se.h/2,12,'#b040ff',3,16,2);
          hits++;
        }
      }
      if(hits>0) sfx(380,.08,'triangle',.05,.65);
    }
  }

  if(coop.on){
    var A=coop.ally; A.x=lerp(A.x||P.x+22,P.x+22,.08); A.y=lerp(A.y||P.y-4,P.y-4,.08); A.cd=max(0,A.cd-1);
    if(A.cd<=0){var ce=null,cd=300;for(var ci=0;ci<enemies.length;ci++){var ee=enemies[ci];if(ee.dead)continue;var dd=dst(A.x,A.y,ee.x,ee.y);if(dd<cd){cd=dd;ce=ee;}} if(ce){A.cd=16;hurtEnemy(ce,10+prog.lvl*.6);}}
  }
  if(cloneT>0&&frameN%10===0){
    var cl=null,cd2=240;for(var ci2=0;ci2<enemies.length;ci2++){var e2=enemies[ci2];if(e2.dead)continue;var dd2=dst(P.x-P.facing*30,P.y-10,e2.x,e2.y);if(dd2<cd2){cd2=dd2;cl=e2;}}
    if(cl) hurtEnemy(cl,8+prog.skills.crit*2);
  }

  // ---- Drone pet ----
  pet.x=lerp(pet.x||P.x,P.x-28*P.facing,.08); pet.y=lerp(pet.y||P.y-50,P.y-50,.08);
  pet.cd=max(0,pet.cd-1);
  if(pet.cd<=0){
    var te=null,td=300;for(var pe=0;pe<enemies.length;pe++){var ee=enemies[pe];if(ee.dead)continue;var dd=dst(pet.x,pet.y,ee.x,ee.y-ee.h/2);if(dd<td){td=dd;te=ee;}}
    if(te){pet.cd=max(12,40-pet.lvl*4);hurtEnemy(te,6+pet.lvl*2);emitP(te.x,te.y-te.h/2,6,'#44ffcc',2,12,2);}
  }

  // ---- Turrets ----
  turrets=turrets.filter(function(tu){
    tu.life--;
    if(tu.hp<=0||tu.life<=0){emitP(tu.x,tu.y,14,'#ffaa00',4,18,3);return false;}
    var now=performance.now();
    if(now-tu.lastF>tu.rate){
      var cl=null,cd=tu.range;
      for(var ti=0;ti<enemies.length;ti++){var e=enemies[ti];if(e.dead)continue;var d=dst(tu.x,tu.y,e.x,e.y);if(d<cd){cd=d;cl=e;}}
      if(cl){
        tu.lastF=now;
        var ta=ang(tu.x,tu.y-10,cl.x,cl.y-cl.h/2)+rnd(-.04,.04);
        bullets.push({x:tu.x,y:tu.y-14,vx:cos(ta)*13,vy:sin(ta)*13,dmg:tu.dmg,life:38,col:'#ffaa00',sz:2,fri:true,kb:1});
      }
    }
    return true;
  });

  // ---- Grenades ----
  grenades=grenades.filter(function(gr){
    gr.x+=gr.vx*tm;gr.y+=gr.vy*tm;gr.vy+=GRAV*.75*tm;gr.vx*=.99;gr.timer--;
    // Bounce
    for(var gi=0;gi<platforms.length;gi++){
      var p=platforms[gi];
      if(gr.x>=p.x&&gr.x<=p.x+p.w&&gr.vy>0&&gr.y>=p.y-3&&gr.y<=p.y+10){
        gr.vy=-abs(gr.vy)*.35;gr.y=p.y-3;gr.vx*=.75;
      }
    }
    if(gr.timer<=0){explode(gr.x,gr.y,gr.r,gr.dmg);return false;}
    return true;
  });

  // ---- Particles ----
  var pCap=perf.low?220:420; if(particles.length>pCap) particles.splice(0,particles.length-pCap);
  particles=particles.filter(function(p){
    p.x+=p.vx;p.y+=p.vy;p.vy+=p.g;p.vx*=p.fr;p.life--;return p.life>0;
  });

  // ---- Explosions ----
  explosions=explosions.filter(function(e){e.life--;return e.life>0;});

  // ---- Pickups ----
  pickups=pickups.filter(function(p){
    if(p.got)return false;p.life--;if(p.life<=0)return false;
    if(dst(P.x,P.y,p.x,p.y)<35){collectPick(p);return false;}
    return true;
  });

  if(ghost.active&&dst(P.x,P.y,ghost.x,ghost.y)<48){ghost.active=false;ghost.retrieved=true;P.hp=min(P.mhp,P.hp+round(P.mhp*.45));announce('Body recovered');}
  if(director.assist>0&&frameN%180===0){P.sh=min(P.msh,P.sh+6*director.assist);}
  // Tooltip
  var tip=document.getElementById('tip');
  var cpick=null,cpd=55;
  var ti;
  for(ti=0;ti<pickups.length;ti++){var pk=pickups[ti];if(pk.got)continue;var dd=dst(P.x,P.y,pk.x,pk.y);if(dd<cpd){cpd=dd;cpick=pk;}}
  var cchest=null;
  for(ti=0;ti<platforms.length;ti++){
    var pl=platforms[ti];
    if(pl.hasChest&&!pl.chestOpened){
      var dc=dst(P.x,P.y,pl.cx,pl.cy-12);
      if(dc<65&&dc<cpd){cpd=dc;cchest=pl;cpick=null;}
    }
  }
  if(cpick){
    var nm={health:'Health Pack',ammo:'Ammo Crate',shield:'Shield Cell',weapon:'Weapon Cache'};
    tip.textContent='[E] '+nm[cpick.type];
    tip.style.left=(cpick.x-cam.x+W/2)+'px';tip.style.top=(cpick.y-cam.y+H/2-28)+'px';
    tip.classList.add('on');
  } else if(cchest){
    tip.textContent='[E] Open Chest';
    tip.style.left=(cchest.cx-cam.x+W/2)+'px';tip.style.top=(cchest.cy-cam.y+H/2-32)+'px';
    tip.classList.add('on');
  } else tip.classList.remove('on');

  if(eventState.t>0){
    eventState.t--;
    if(eventState.meteor&&frameN%55===0){var mxp=P.x+rnd(-260,260), myp=P.y-rnd(120,220); explode(mxp,myp,95,26);}
    if(eventState.storm&&frameN%70===0){hurtPlayer(3);}
  }

  // ---- Camera ----
  cam.tx=P.x; cam.ty=P.y-H*.16;
  cam.x=lerp(cam.x,cam.tx,.07);
  cam.y=lerp(cam.y,cam.ty,.07);

  // Shake
  shake=shake>.4?shake*.88:0;

  // Shield regen
  if(P.sh<P.msh&&!P.shieldWall) P.sh+=.025;

  updateContracts();
  if(frameN%120===0){if(kills>=50) unlockAch('killer50','50 Kills'); if(wave>=10) unlockAch('wave10','Wave 10');}
  updHUD();
  drawMinimap();
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN DRAW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function draw(t){
  X.save();
  if(vfxPulse>0) vfxPulse*=.92;
  if(shake>.3) X.translate(rnd(-shake,shake),rnd(-shake,shake));
  drawSky(); if(!perf.low) drawStars(t); if(!perf.low) drawNebs(t);
  var di;
  for(di=0;di<bridges.length;di++) drawBridge(bridges[di]);
  for(di=0;di<platforms.length;di++) drawPlatform(platforms[di]);
  drawPickups(t);drawTurrets(t);drawGrenades();
  for(var pi=0;pi<portals.length;pi++){var po=portals[pi],psx=po.x-cam.x+W/2,psy=po.y-cam.y+H/2;X.strokeStyle='rgba(180,120,255,.8)';X.lineWidth=2;X.beginPath();X.arc(psx,psy,14+sin(t*.01)*2,0,TAU);X.stroke();}
  for(var ti=0;ti<traps.length;ti++){var tr=traps[ti],tsx=tr.x-cam.x+W/2,tsy=tr.y-cam.y+H/2;X.fillStyle=tr.on?'#ff8830':'#666';X.fillRect(tsx-6,tsy-3,12,6);}
  var dsx=pet.x-cam.x+W/2,dsy=pet.y-cam.y+H/2;X.fillStyle='#44ffcc';X.beginPath();X.arc(dsx,dsy,6,0,TAU);X.fill();
  if(reflectT>0){var psx=P.x-cam.x+W/2,psy=P.y-cam.y+H/2-18;X.strokeStyle='rgba(120,220,255,.7)';X.beginPath();X.arc(psx,psy,22+sin(t*.02)*2,0,TAU);X.stroke();}
  if(cloneT>0){var csx=P.x-cam.x+W/2-P.facing*24,csy=P.y-cam.y+H/2-12;X.globalAlpha=.55;X.fillStyle='#66e0ff';X.fillRect(csx-7,csy-16,14,16);X.globalAlpha=1;}
  if(coop.on){var asx=coop.ally.x-cam.x+W/2,asy=coop.ally.y-cam.y+H/2;X.fillStyle='#66aaff';X.fillRect(asx-7,asy-16,14,16);}
  if(pvpState.on){var p2=pvpState.p2;var px=p2.x-cam.x+W/2,py=p2.y-cam.y+H/2;X.fillStyle='#ff66aa';X.fillRect(px-7,py-16,14,16);X.fillStyle='rgba(255,255,255,.85)';X.font='10px Share Tech Mono';X.textAlign='center';X.fillText((p2.name||'Rival'),px,py-22);}
  if(ghost.active){var gx=ghost.x-cam.x+W/2,gy=ghost.y-cam.y+H/2;X.globalAlpha=.45;X.fillStyle='#b6f2ff';X.beginPath();X.arc(gx,gy-14,10,0,TAU);X.fill();X.globalAlpha=1;}
  for(di=0;di<enemies.length;di++) drawEnemyFn(enemies[di],t);
  drawPlayer(t);drawBullets();drawParticles();drawExplosions();
  drawVignette();drawVoidFog();
  if(hitFlash>0){
    X.globalAlpha=hitFlash*.16;X.fillStyle='#ff3040';X.fillRect(0,0,W,H);X.globalAlpha=1;
    hitFlash*=.84;
  }
  var bloom=(perf.low?0.02:0.04)+vfxPulse*.06+(overdriveT>0?.08:0)+(chronoT>0?.05:0)+(stormT>0?.04:0);
  X.globalAlpha=bloom;X.fillStyle=chronoT>0?'#66d8ff':stormT>0?'#c266ff':'#00e8ff';X.fillRect(0,0,W,H);X.globalAlpha=1;
  X.restore();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT / GAME LOOP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initGame(){
  var cls=CLASSES[selClass];
  runBuffs={dmg:1,spd:1,combo:1,shield:0};
  selectMapTheme();
  genWorld();

  var center=platforms.find(function(p){return p.isCenter;})||platforms[0];
  P.x=center.cx; P.y=center.y-2; P.prevY=P.y;
  P.vx=0;P.vy=0;
  P.hp=selMode==='onelife'?1:cls.hp;P.mhp=selMode==='onelife'?1:cls.hp;P.sh=selMode==='onelife'?0:cls.sh;P.msh=selMode==='onelife'?0:cls.sh;
  P.spd=cls.spd;P.jmp=cls.jmp;P.grounded=true;
  if(selTalent==='glass'){runBuffs.dmg*=1.2;P.mhp*=.82;P.hp=min(P.hp,P.mhp);}
  if(selTalent==='adrenaline'){runBuffs.spd*=1.15;}
  if(selTalent==='guardian'){P.sh+=30;P.msh+=30;}
  if(prog.lvl>=12){runBuffs.dmg*=1.12;runBuffs.spd*=1.08;announce('CLASS EVOLUTION ONLINE');}
  var av=AVATARS[cosmetics.avatar]||AVATARS.zr7; if(av.perk==='jump') P.jmp*=1.06; if(av.perk==='crit') prog.crit=min(.35,prog.crit+.03);
  rollCardsAndCurse(); if(curse.active){runBuffs.dmg*=1.08;}
  pet.lvl=1+floor(prog.lvl/4)+pet.upgrade;
  contracts={kill:0,target:25+wave*0,boss:0,targetBoss:1,done:false};
  var baseWeaps=(selMode==='sniper'?['sniper']:(cls.weap.slice()));
  if(prog.unlocks.laser&&baseWeaps.indexOf('laser')<0&&selMode!=='sniper') baseWeaps.push('laser');
  if(prog.unlocks.launcher&&baseWeaps.indexOf('launcher')<0&&selMode!=='sniper') baseWeaps.push('launcher');
  P.weaps=baseWeaps.map(function(wt){
    var wd=WEAPS[wt];
    var rr=rollRarity(), rv=RARITY[rr];
    var obj={type:wt,name:wd.name,icon:wd.icon,dmg:wd.dmg*rv.m,rate:wd.rate*(rr==='mythic'?0.86:1),spread:wd.spread,bul:wd.bul,spd:wd.spd,ammo:wd.maxA,maxA:wd.maxA,rld:wd.rld,range:wd.range,col:rv.col||wd.col,sz:wd.sz+(rr==='legendary'||rr==='mythic'?1:0),kb:wd.kb,rarity:rr};
    if(wd.expl) obj.expl=true;
    return obj;
  });
  P.wi=0;P.lastFire=0;P.reloading=false;
  P.abilLast=-1e5;P.invuln=0;
  P.shieldWall=false;P.focus=false;
  P.facing=1;P.anim=0;P.canDJ=true; coop.ally={x:P.x+22,y:P.y-4,vx:0,vy:0,hp:120,mhp:120,cd:0};

  bullets=[];enemies=[];particles=[];pickups=[];explosions=[];turrets=[];grenades=[];
  score=0;kills=0;wave=0;combo=0;comboT=0;maxCombo=0;dmgDealt=0;
  bossOn=false;bossRef=null;shake=0;slowT=0;slowF=1;overdriveT=0;vfxPulse=0;hitFlash=0;superE=35;chronoT=0;stormT=0;stormTick=0;
  superCD={nova:0,chrono:0,storm:0}; modeTimeLeft=300; eventState={name:'',t:0,meteor:0,storm:0,toxic:0,exploders:0}; ghost={active:false,x:0,y:0,retrieved:false}; secretBoss.spawned=false; pvpState.p2={x:P.x+120,y:P.y,vx:0,vy:0,hp:120,mhp:120,name:'Rival'};
  enKilled=0;enThisWave=0;frameN=0;

  document.getElementById('bossbar').style.display='none';
  buildWBar();buildAbilUI();

  state='playing';
  runStart=performance.now(); runXP=0;
  document.getElementById('shop').classList.remove('on');
  document.getElementById('pause').classList.remove('on');
  document.getElementById('hud').classList.add('active');
  document.getElementById('minimap-c').classList.add('active');
  document.getElementById('wbar').classList.add('active');
  document.getElementById('abil').classList.add('active');
  document.getElementById('cross').classList.add('active');
  document.getElementById('superbar').classList.add('active');

  // Start cam at player
  cam.x=P.x;cam.y=P.y-H*.16;

  announce('ğŸš€ DEPLOYING TO '+mapSet.toUpperCase());
  slowT=40; slowF=.6;
  setTimeout(nextWave,900);
}

function endGame(reason){
  lastEndReason=reason||'DEFEAT';
  state='gameover';
  if(spawnTimer) clearInterval(spawnTimer);
  ['hud','minimap-c','wbar','abil','cross','superbar'].forEach(function(id){document.getElementById(id).classList.remove('active');});
  document.getElementById('pause').classList.remove('on');

  if(score>bestScore) bestScore=score;
  if(wave>bestWave) bestWave=wave;
  if(score>(modeBest[selMode]||0)) modeBest[selMode]=score;
  updateLeague();
  globalRank.push({s:score,m:selMode,w:wave,k:kills,t:Date.now()});globalRank.sort(function(a,b){return b.s-a.s;});globalRank=globalRank.slice(0,100);
  if(weekly.progress>=weekly.goal){rareCoins+=weekly.reward;weekly.progress=0;announce('Weekly reward +'+weekly.reward+' rare');}
  story.chapter=max(story.chapter,wave>=20?3:wave>=10?2:1);
  saveMeta();
  renderMeta();

  var go=document.getElementById('scrGO');go.classList.remove('off');
  var gt=document.getElementById('goTitle'); if(gt) gt.textContent=(/VICTORY/.test(lastEndReason)?'MISSION COMPLETE':lastEndReason==='TIME UP'?'TIME UP':'MISSION FAILED');
  document.getElementById('goMeta').innerHTML='Session Best <b>'+bestScore.toLocaleString()+'</b>';
  document.getElementById('goGrid').innerHTML=
    '<div class="go-s"><div class="go-v">'+score.toLocaleString()+'</div><div class="go-l">Score</div></div>'+
    '<div class="go-s"><div class="go-v">'+kills+'</div><div class="go-l">Kills</div></div>'+
    '<div class="go-s"><div class="go-v">'+wave+'</div><div class="go-l">Wave</div></div>'+
    '<div class="go-s"><div class="go-v">'+maxCombo+'x</div><div class="go-l">Max Combo</div></div>'+
    '<div class="go-s"><div class="go-v">'+round(dmgDealt)+'</div><div class="go-l">Damage</div></div>'+
    '<div class="go-s"><div class="go-v">'+CLASSES[selClass].name+'</div><div class="go-l">Class</div></div>'+
    '<div class="go-s"><div class="go-v">'+DIFFS[selDiff].name+'</div><div class="go-l">Difficulty</div></div>'+
    '<div class="go-s"><div class="go-v">'+MODES[selMode].name+'</div><div class="go-l">Mode</div></div>'+
    '<div class="go-s"><div class="go-v">LV '+prog.lvl+'</div><div class="go-l">Profile</div></div>'+
    '<div class="go-s"><div class="go-v">'+((performance.now()-runStart)/1000).toFixed(1)+'s</div><div class="go-l">Survival</div></div>'+
    '<div class="go-s"><div class="go-v">+'+round(runXP)+'</div><div class="go-l">Run XP</div></div>'+
    '<div class="go-s"><div class="go-v">#'+(globalRank.findIndex(function(r){return r.s===score&&r.m===selMode;})+1)+'</div><div class="go-l">Global Rank*</div></div>';
}

var lastT=0;
function loop(ts){
  var dt=min(ts-lastT,33);lastT=ts;
  perf.avg=perf.avg*.92+dt*.08; perf.low=perf.force||perf.avg>22; if(perf.low&&frameN%90===0){bullets.length=min(bullets.length,280);}
  update();draw(ts);
  requestAnimationFrame(loop);
}

// ---- Dark mode ----
if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches)document.documentElement.classList.add('dark');
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',function(e){if(e.matches){document.documentElement.classList.add('dark');}else{document.documentElement.classList.remove('dark');}});

// ---- Init UI ----
loadMeta();
renderMeta();
buildClsSel();
buildDiffSel();
buildModeSel();
buildTalentSel();
buildSkillTree();
buildCoopSel();
buildSkinSel();
buildAvatarSel();
checkDaily();
var sfxBtn=document.getElementById('sfxBtn');if(sfxBtn)sfxBtn.addEventListener('click',function(ev){ev.stopPropagation();toggleSfx();});
['mousedown','touchstart','keydown'].forEach(function(evt){addEventListener(evt,unlockAudio,{once:true});});

document.getElementById('btnPlay').addEventListener('click',function(){
  unlockAudio();
  document.getElementById('scrTitle').classList.add('off');
  selAvatar=cosmetics.avatar||'zr7';
  if(selMode==='pvp_online') buildOnlineSel();
  initGame();
});
document.getElementById('btnRetry').addEventListener('click',function(){
  unlockAudio();
  document.getElementById('scrGO').classList.add('off');
  initGame();
});
var sc=document.getElementById('shopContinue');if(sc)sc.addEventListener('click',function(){document.getElementById('shop').classList.remove('on');state='playing';shopPending=false;spawnWaveNow();});
var cb=document.getElementById('connectBtn'); if(cb) cb.addEventListener('click',function(){buildOnlineSel(true);});
var tc=document.getElementById('toggleControls'); if(tc) tc.addEventListener('click',function(){var box=document.getElementById('controlsBox'); if(!box) return; box.classList.toggle('on'); tc.textContent=box.classList.contains('on')?'Ocultar controles':'Ver controles'; if(box.classList.contains('on')) box.scrollIntoView({behavior:'smooth',block:'nearest'});});
var pb=document.getElementById('perfBtn'); if(pb) pb.addEventListener('click',function(){perf.force=!perf.force; pb.textContent='Modo rendimiento: '+(perf.force?'ON':'AUTO');});

requestAnimationFrame(loop);
</script>


</body></html>
